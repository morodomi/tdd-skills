---
name: tdd-review
description: REVIEWフェーズ用。REFACTORフェーズ完了後の最終的な品質検証を行う。すべてのテスト実行、品質基準チェック、最新TDDドキュメント（docs/YYYYMMDD_hhmm_*.md）の要件確認、Code Review（/code-review、3つのSubagent並行実行）、レビューレポート生成を実施。ユーザーが「review」「レビュー」と言った時、REFACTORフェーズ完了後、または /tdd-review コマンド実行時に使用。
allowed-tools: Read, Grep, Glob, Bash, Task, SlashCommand
---

# TDD REVIEW Phase

あなたは現在 **REVIEWフェーズ** にいます。

## このフェーズの目的

REFACTORフェーズ完了後の**最終的な品質検証**を行うことです。
コミット前に、すべての要件と品質基準を満たしていることを確認します。

## このフェーズでやること

- [ ] TDDドキュメントを読み込み、要件と品質基準を確認する
- [ ] すべてのテストを実行する
- [ ] 品質チェックツールを実行する（PHPStan, カバレッジ）
- [ ] TDDドキュメントの要件を満たしているか確認する
- [ ] **Code Review実行**（`/code-review`、3つのSubagent並行実行）
- [ ] レビューレポートを生成する
- [ ] 次のフェーズ（DOC/COMMIT）を案内する

## このフェーズで絶対にやってはいけないこと

- 実装コードを変更すること（チェックのみ）
- テストコードを変更すること
- 品質チェックをスキップすること
- 要件確認をスキップすること

## ワークフロー

### 1. 準備フェーズ

まず、TDDドキュメントを読み込んで要件と品質基準を確認してください：

```bash
# 最新のTDDドキュメントを検索
ls -t docs/202*.md 2>/dev/null | head -1

# TDDドキュメントの読み込み
Read docs/YYYYMMDD_hhmm_<機能名>.md
```

TDDドキュメントから以下の情報を抽出してください：

1. **実装範囲**
   - 対象ファイル
   - 対象外（実装すべきでないもの）

2. **受け入れ基準**
   - Given/When/Thenで定義されたシナリオ
   - 各シナリオが満たされているか

3. **品質基準**
   - テストカバレッジ目標
   - PHPStanレベル
   - その他の品質基準

これらの情報を基に、レビューを実施します。

### 2. テスト検証フェーズ

すべてのテストを実行して、テストが通っていることを確認してください：

```bash
# すべてのテストを実行
php artisan test
```

**テストが通った場合**:
```
✓ すべてのテストが通りました。

テスト結果:
- 合格: XX件
- 失敗: 0件
- スキップ: XX件

次の品質チェックに進みます。
```

**テストが失敗した場合**:
```
✗ テストが失敗しています。

失敗したテスト:
[テスト名とエラーメッセージ]

REVIEWフェーズを中断します。
REFACTORフェーズに戻って、テストを修正してください。

現在のTDDワークフロー:
[完了] INIT (初期化)
[完了] PLAN (計画)
[完了] RED (テスト作成)
[完了] GREEN (実装)
[戻る] REFACTOR (リファクタリング) ← ここに戻ってください
[中断] REVIEW (品質検証)
```

テストが失敗している場合は、**REVIEWフェーズをこれ以上進めません**。

### 3. 品質基準チェックフェーズ

テストが通った場合のみ、品質チェックを実施します。

#### 3.1 PHPStan実行

```bash
# PHPStan実行（Level 8）
vendor/bin/phpstan analyse
```

**期待結果**:
- TDDドキュメントで指定されたレベル（通常はLevel 8）
- エラー: 0件

**結果の判定**:

✓ **合格**（エラー0件）:
```
✓ PHPStan: 合格
  - Level: 8
  - エラー: 0件
```

⚠️ **不合格**（エラーあり）:
```
⚠️ PHPStan: 不合格
  - Level: 8
  - エラー: XX件

品質基準を満たしていません。
REFACTORフェーズに戻って修正することを推奨します。

ただし、REVIEWフェーズは継続できます。
最終判定で警告として記録します。
```

#### 3.2 テストカバレッジ確認

```bash
# テストカバレッジ確認
php artisan test --coverage
```

**期待結果**:
- TDDドキュメントで指定されたカバレッジ（通常は90%以上）

**結果の判定**:

✓ **合格**（目標達成）:
```
✓ テストカバレッジ: 合格
  - カバレッジ: XX%
  - 目標: 90%以上
```

⚠️ **不合格**（目標未達）:
```
⚠️ テストカバレッジ: 不合格
  - カバレッジ: XX%
  - 目標: 90%以上

品質基準を満たしていません。
次のTDDサイクルでカバレッジ向上を検討してください。

REVIEWフェーズは継続できます。
最終判定で警告として記録します。
```

### 4. 要件確認フェーズ

TDDドキュメントの要件を満たしているか確認します。

#### 4.1 実装範囲の確認

TDDドキュメントの「実装範囲」セクションと実際の実装ファイルを照合します：

```bash
# 実装ファイルの確認
Glob app/**/*.php
Glob routes/**/*.php
Glob database/migrations/**/*.php
```

**確認内容**:
1. TDDドキュメントの「対象ファイル」に記載されたファイルが実装されているか
2. 記載されていないファイルが追加されていないか（柔軟に判断）

**結果**:
```
実装範囲の確認:

✓ 対象ファイル:
  - app/Models/XXX.php ✓ 実装済み
  - app/Http/Controllers/XXXController.php ✓ 実装済み
  - routes/web.php ✓ 更新済み

ℹ️ その他のファイル:
  - app/Services/XXXService.php (TDDドキュメントに記載なし)
  → 実装の過程で必要になったと判断
```

#### 4.2 対象外機能の確認

TDDドキュメントの「対象外」セクションに記載された機能が実装されていないか確認します：

```
対象外機能の確認:

✓ 以下の機能は実装されていません（正しい）:
  - [対象外機能1]
  - [対象外機能2]

または

⚠️ 以下の対象外機能が実装されています:
  - [機能名] (ファイル: XXX.php)
  → TDDドキュメントの範囲外です。別のTDDサイクルで実装すべきでした。
```

#### 4.3 受け入れ基準の確認

TDDドキュメントの受け入れ基準（Given/When/Then）を満たしているか確認します：

**確認方法**:
1. TDDドキュメントの受け入れ基準セクションを読む
2. 各シナリオのGiven/When/Thenを確認
3. 対応するテストファイルを検索（Grep等で）
4. テストメソッド名やコメントから対応関係を確認
5. テストが通っているか確認（既にテスト検証フェーズで確認済み）

**対応関係の確認のヒント**:
- テストメソッド名に受け入れ基準のキーワードが含まれているか
- テストコード内のGiven/When/Thenコメントを確認
- TDDドキュメントのシナリオ番号とテストの対応を確認

```
受け入れ基準の確認:

シナリオ1: [シナリオ名]
  ✓ テスト: tests/Feature/XXXTest.php::test_scenario_1
  ✓ 状態: 合格

シナリオ2: [シナリオ名]
  ✓ テスト: tests/Feature/XXXTest.php::test_scenario_2
  ✓ 状態: 合格

すべての受け入れ基準を満たしています。
```

### 5. Code Reviewフェーズ

品質基準チェック完了後、Code Reviewを実施します。以下のコマンドで、3つのSubagentを並行実行します：

```bash
/code-review
```

このコマンドは、以下の3つのレビュー視点を並行実行します：

**1. セキュリティレビュー**
- 入力検証、出力エスケープ
- Nonce検証、権限チェック（WordPress固有）
- SQLインジェクション対策

**2. パフォーマンスレビュー**
- N+1クエリ問題
- 不必要なループや計算
- キャッシング戦略

**3. コード品質レビュー**
- 責任分離、DRY原則
- テスト可能性
- 保守性

**Code Review実行例**:

```
Code Review実行中...

1. セキュリティレビュー (Subagent-1)
   - 検査中: サニタイズ/エスケープ処理
   - 検査中: Nonce検証
   - 検査中: 権限チェック

2. パフォーマンスレビュー (Subagent-2)
   - 検査中: N+1クエリ
   - 検査中: キャッシング戦略
   - 検査中: 計算量

3. コード品質レビュー (Subagent-3)
   - 検査中: 責任分離
   - 検査中: テスト可能性
   - 検査中: 保守性

3つのレビューが並行実行されます...

================================================================================
Code Review 結果
================================================================================

1. セキュリティレビュー
   状態: [合格/警告/不合格]
   指摘事項:
   - [指摘1]
   - [指摘2]

2. パフォーマンスレビュー
   状態: [合格/警告/不合格]
   指摘事項:
   - [指摘1]
   - [指摘2]

3. コード品質レビュー
   状態: [合格/警告/不合格]
   指摘事項:
   - [指摘1]
   - [指摘2]

================================================================================
```

**Code Review指摘への対応**:

Code Reviewで指摘がある場合：

- 「不合格」: REFACTORフェーズに戻り、指摘事項を修正することを強く推奨
- 「警告」: ドキュメントに記録し、次のサイクルでの改善を検討
- 「合格」: そのままREVIEWフェーズを続行

### 6. レビューレポート生成フェーズ

すべてのチェックが完了したら、総合的なレビューレポートを生成します。

#### レビューレポート

以下の形式でレポートを生成してください（日時は実際の現在日時を使用）：

```
================================================================================
TDD REVIEW レポート
================================================================================

プロジェクト: [機能名]
レビュー日時: [実際の現在日時 YYYY-MM-DD HH:MM形式]

--------------------------------------------------------------------------------
1. テスト検証
--------------------------------------------------------------------------------
✓ 合格
  - 合格: XX件
  - 失敗: 0件
  - スキップ: XX件

--------------------------------------------------------------------------------
2. 品質基準チェック
--------------------------------------------------------------------------------
✓ PHPStan (Level 8): エラー 0件
✓ テストカバレッジ: XX% (目標: 90%以上)

--------------------------------------------------------------------------------
3. 要件確認
--------------------------------------------------------------------------------
✓ 実装範囲: 対象ファイルすべて実装済み
✓ 対象外機能: 実装なし（正しい）
✓ 受け入れ基準: すべてのシナリオで合格

--------------------------------------------------------------------------------
4. Code Review
--------------------------------------------------------------------------------
✓ セキュリティレビュー: 合格 (指摘 0件)
✓ パフォーマンスレビュー: 合格 (指摘 0件)
✓ コード品質レビュー: 合格 (指摘 0件)

--------------------------------------------------------------------------------
5. 総合判定
--------------------------------------------------------------------------------
✅ 合格

すべての要件、品質基準、Code Review指摘事項を満たしています。
DOC/COMMITフェーズに進むことができます。

================================================================================
```

**総合判定の基準**:

✅ **合格**:
- すべてのテストが通っている（必須）
- PHPStanエラー0件（完全合格の条件）
- テストカバレッジが目標以上（完全合格の条件）
- 実装範囲を満たしている（必須）
- Code Reviewが「合格」（必須）

⚠️ **条件付き合格**（警告あり）:
- すべてのテストが通っている（必須）
- PHPStan、カバレッジ、Code Reviewのいずれかが基準未達または警告（警告として記録）
- 実装範囲をほぼ満たしている（必須）

```
⚠️ 条件付き合格（警告あり）

以下の警告があります:
- テストカバレッジ: XX% (目標: 90%以上)
- Code Review セキュリティ: 警告 (1件の指摘)

改善を推奨しますが、DOC/COMMITフェーズに進むことは可能です。
```

✗ **不合格**:
- テストが失敗している
- Code Reviewが「不合格」判定（セキュリティ/重大な品質問題）

```
✗ 不合格

Code Reviewで「不合格」判定を受けました。
REFACTORフェーズに戻って、指摘事項を修正してください。

不合格理由:
- Code Review セキュリティ: 不合格 (XX件の指摘)

修正後、再度REVIEWフェーズを実行してください。
```

### 7. 完了フェーズ

レビューが合格した場合、次のステップを案内します：

```
REVIEWフェーズが完了しました。

品質検証結果:
- テスト: 合格 XX件、失敗 0件
- 静的解析: 合格（Level 8, エラー 0件）
- カバレッジ: XX% (合格)
- Code Review: 合格 (セキュリティ/パフォーマンス/品質: すべて合格)

現在のTDDワークフロー:
[完了] INIT (初期化)
[完了] PLAN (計画)
[完了] RED (テスト作成)
[完了] GREEN (実装)
[完了] REFACTOR (リファクタリング)
[完了] REVIEW (品質検証) ← 現在ここ
[次] DOC (ドキュメント更新)
[ ] COMMIT (コミット)

次のステップ:
1. DOCフェーズ: TDDドキュメントを更新してください
   - 実装の詳細を記録
   - Code Reviewで指摘された改善ポイントを記録
   - 変更点や注意事項を追記

2. その後、COMMITフェーズに進んでください
   - git add .
   - git commit -m "feat: [機能名]を実装"
```

## WordPress固有の品質チェック

WordPress環境では、以下の追加チェックリストを確認してください。

### セキュリティチェックリスト

- [ ] **入力サニタイズ**: すべてのユーザー入力に `sanitize_*` 関数を使用
  - `sanitize_text_field()`, `sanitize_textarea_field()`, `sanitize_email()` 等
  - フォーム送信データ (`$_POST`, `$_GET`) のサニタイズ
  - ファイルアップロードのサニタイズ (`sanitize_file_name()`)

- [ ] **出力エスケープ**: すべての出力に `esc_*` 関数を使用
  - HTML出力: `esc_html()`
  - 属性値: `esc_attr()`
  - URL: `esc_url()`
  - JavaScript: `wp_json_encode()`

- [ ] **Nonce検証**: フォーム送信時に `wp_verify_nonce()` を実装
  - フォーム生成時: `wp_nonce_field()`
  - フォーム処理時: `wp_verify_nonce()`
  - AJAX処理: `check_ajax_referer()`

- [ ] **権限チェック**: 管理機能に `current_user_can()` を実装
  - 管理画面: `manage_options`
  - 投稿編集: `edit_post`, `edit_posts`
  - カスタム権限の適切な使用

- [ ] **SQLインジェクション対策**: `$wpdb->prepare()` を使用（直接クエリ実行時）
  - wpdbを使う場合は必ず `prepare()` でエスケープ
  - WordPress関数（`wp_insert_post()` 等）の優先使用

**検証方法**:
```bash
# サニタイズ漏れチェック
grep -r "\$_POST\|" --include="*.php" src/ | grep -v "sanitize_"

# エスケープ漏れチェック
grep -r "echo \$" --include="*.php" src/ | grep -v "esc_"

# Nonce未検証チェック
grep -r "\$_POST" --include="*.php" src/ | grep -v "wp_verify_nonce"
```

### WordPress規約チェックリスト

- [ ] **WordPress関数優先**: 直接DBアクセスを避け、WordPress関数を使用
  - `wp_insert_post()`, `update_post_meta()`, `get_option()` 等を使用
  - `$wpdb` の直接使用を最小限に抑える

- [ ] **Hooks/Filters**: 拡張ポイントに `apply_filters()` / `do_action()` を配置
  - 設定値に `apply_filters()` を使用
  - 処理の前後に `do_action()` を配置

- [ ] **国際化対応**: 文字列に `__()`, `_e()`, `esc_html__()` を使用
  - すべての表示文字列を翻訳可能に
  - テキストドメインを統一（プラグイン/テーマスラッグと同じ）

- [ ] **Coding Standards**: Laravel Pintで自動チェック（`composer pint`）
  - PSR-12準拠
  - WordPress Coding Standards準拠
  - スネークケース関数名

- [ ] **後方互換性**: 既存機能を壊さない変更
  - 既存のフック/フィルタ名を変更しない
  - 既存のオプション名を変更しない
  - 既存の公開APIを維持

**検証方法**:
```bash
# Coding Standards チェック
composer pint

# WordPress関数優先チェック
grep -r "\$wpdb->" --include="*.php" src/ | wc -l  # 少ないほど良い

# 国際化漏れチェック
grep -r "echo '" --include="*.php" src/ | grep -v "__\|_e\|esc_html__"
```

### 静的解析チェックリスト

- [ ] **PHPStan Level 8**: エラー0件（`composer stan`）
  - 型安全性の確保
  - 未定義変数/メソッドの検出
  - 返り値の型チェック

- [ ] **WordPress型定義**: `szepeviktor/phpstan-wordpress` ルール準拠
  - WordPress関数の型チェック
  - フック/フィルタの型チェック

- [ ] **型安全性**: すべての関数/メソッドに型宣言
  - 引数の型宣言
  - 返り値の型宣言
  - プロパティの型宣言（PHP 7.4+）

**検証方法**:
```bash
# PHPStan実行
composer stan

# または
vendor/bin/phpstan analyse --memory-limit=1G

# エラー件数確認
vendor/bin/phpstan analyse --error-format=table | grep "errors"
```

### テストカバレッジチェックリスト

- [ ] **カバレッジ90%以上**: `composer test -- --coverage-text`
  - Unit Testsでカバー: 純粋なロジック
  - Integration Testsでカバー: WordPress環境が必要な処理

- [ ] **Unit/Integration分離**: 適切なテストスイートに配置
  - `tests/Unit/`: `PHPUnit\Framework\TestCase` 継承
  - `tests/Integration/`: `WP_UnitTestCase` 継承

- [ ] **WordPress関数モック**: Brain Monkeyまたはwp-phpunitで適切にモック
  - Unit Tests: Brain Monkeyでモック
  - Integration Tests: wp-phpunitの実環境

**検証方法**:
```bash
# カバレッジ取得
composer test -- --coverage-text

# または
vendor/bin/phpunit --coverage-text

# カバレッジ90%未満のファイル確認
vendor/bin/phpunit --coverage-text | grep -A 1000 "Code Coverage Report" | grep -E "^\s+[0-8][0-9]?\.[0-9]+%"
```

### WordPress固有のレビュー観点

#### 1. セキュリティ優先

WordPress環境では、セキュリティが最優先です：

```php
// ✅ Good: サニタイズ+エスケープ
function display_weather($city) {
    $city = sanitize_text_field($city);  // 保存前
    $data = get_transient("weather_{$city}");
    echo esc_html($data['temp']) . '°C';  // 表示時
}

// ❌ Bad: エスケープなし
function display_weather($city) {
    $data = get_transient("weather_{$city}");
    echo $data['temp'] . '°C';  // XSS脆弱性
}
```

#### 2. WordPress関数の使用確認

```php
// ✅ Good: WordPress関数
update_post_meta($post_id, 'weather', sanitize_text_field($value));

// ❌ Bad: 直接DB操作
global $wpdb;
$wpdb->update($wpdb->postmeta, ['meta_value' => $value], ['meta_key' => 'weather']);
```

#### 3. フック/フィルタの拡張性

```php
// ✅ Good: 拡張可能
$api_key = apply_filters('weather_api_key', get_option('weather_api_key'));

// ❌ Bad: ハードコード
$api_key = get_option('weather_api_key');
```

### レビュー完了時のメッセージ例（WordPress版）

```
✓ REVIEWフェーズが完了しました。

品質チェック結果:
[✓] PHPStan Level 8: 0 errors
[✓] テストカバレッジ: 95%
[✓] Laravel Pint: すべて合格
[✓] セキュリティ: サニタイズ/エスケープ/Nonce検証 OK
[✓] WordPress規約: WordPress関数優先、Hooks/Filters OK
[✓] 国際化: すべての文字列に翻訳関数使用

Code Review結果:
[✓] セキュリティレビュー: 合格 (指摘 0件)
[✓] パフォーマンスレビュー: 合格 (指摘 0件)
[✓] コード品質レビュー: 合格 (指摘 0件)

現在のTDDワークフロー:
[完了] INIT (初期化)
[完了] PLAN (計画)
[完了] RED (テスト作成)
[完了] GREEN (実装)
[完了] REFACTOR (リファクタリング)
[完了] REVIEW (品質検証) ← 現在ここ
[次] DOC (ドキュメント更新)
[次] COMMIT (コミット)

次のステップ:
1. DOCフェーズ: TDDドキュメントを更新してください
   - 実装の詳細を記録
   - セキュリティ対策の内容を記録
   - Code Reviewで指摘された改善ポイントを記録
   - WordPress固有の実装ポイントを記録

2. その後、COMMITフェーズに進んでください
```

---

## 制約の強制

このフェーズでは、`allowed-tools: Read, Grep, Glob, Bash` のみ使用可能です。

**Write, Editツールは使用できません**。REVIEWフェーズは読み取り専用です。

もしユーザーが以下のような依頼をした場合は、**丁寧に拒否**してください：

- 「テストを修正して」→ 「REVIEWフェーズでは実装コードを変更できません。REFACTORフェーズに戻ってください」
- 「コードを改善して」→ 「REVIEWフェーズはチェックのみです。改善が必要な場合はREFACTORフェーズに戻ってください」
- 「TDDドキュメントを更新して」→ 「DOCフェーズで更新します。まずREVIEWを完了させましょう」

## トラブルシューティング

### TDDドキュメントが見つからない場合

```
TDDドキュメントが見つかりません。
REVIEWフェーズを開始する前に、INIT と PLAN フェーズを完了してください。

以下を確認してください：
- docs/YYYYMMDD_hhmm_*.md が存在するか（ls -t docs/202*.md で確認）
- TDDドキュメントに「## PLAN（実装計画）」セクションがあるか
```

### テストが失敗している場合

```
テストが失敗しているため、REVIEWフェーズを続行できません。

REFACTORフェーズに戻って、以下を修正してください：
1. 失敗したテストを確認
2. 実装コードを修正
3. テストが通ることを確認
4. 再度REVIEWフェーズに進む
```

### 品質基準を満たしていない場合

```
品質基準を満たしていません。

不合格項目:
- PHPStan: XX件のエラー
- カバレッジ: XX% (目標: 90%)

選択肢:
1. REFACTORフェーズに戻って改善する（推奨）
2. 警告付きでREVIEWを合格とし、次のTDDサイクルで改善する

どちらにしますか？
```

### 要件を満たしていない場合

```
TDDドキュメントの要件を満たしていない可能性があります。

確認内容:
- 対象ファイル「XXX.php」が実装されていません
- または、対象外機能「YYY」が実装されています

REFACTORフェーズまたはGREENフェーズに戻って修正しますか？
```

## 参考情報

このSkillは、Laravel開発におけるTDDワークフローの一部です。

- 詳細なワークフロー: README.md参照
- プロジェクト設定: CLAUDE.md参照
- 前のフェーズ: tdd-refactor Skill（リファクタリング）
- 次のフェーズ: DOC/COMMIT（ドキュメント更新・コミット）

### REVIEWフェーズの重要性

REVIEWフェーズは、TDDサイクルの最終ゲートです：

- **品質保証**: すべての品質基準を満たしているか確認
- **要件確認**: TDDドキュメントの要件を満たしているか確認
- **コミット前チェック**: 問題を早期発見

「コミットする前に確認する」最後のチャンスです。

### レビューの観点

1. **テストの網羅性**: すべての受け入れ基準がテストされているか
2. **コードの品質**: PHPStan, カバレッジなどの基準を満たしているか
3. **要件の充足**: TDDドキュメントの実装範囲を満たしているか
4. **スコープの遵守**: 対象外の機能を実装していないか

---

*このSkillはClaudeSkillsプロジェクトの一部です*
