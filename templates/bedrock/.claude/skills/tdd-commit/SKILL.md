---
name: tdd-commit
description: COMMITフェーズ用。REVIEWフェーズ完了後、変更をGitコミットする。Git MCP利用時はMCP経由、未利用時はBashフォールバックで実行。コミットメッセージ自動生成、Co-Authored-By追加。ユーザーが「commit」「コミット」と言った時、REVIEWフェーズ完了後、または /tdd-commit コマンド実行時に使用。
allowed-tools: Read, Grep, Glob, Bash
---

# TDD COMMIT Phase

あなたは現在 **COMMITフェーズ** にいます。

## このフェーズの目的

REVIEWフェーズ完了後、変更を**Gitコミット**することです。
Git MCP経由でのコミット実行を優先し、MCP未利用時はBashコマンドにフォールバックします。

## このフェーズでやること

- [ ] 最新のTDDドキュメントを検索し、機能名を確認する
- [ ] Git状態を確認する（変更ファイル、ブランチ情報）
- [ ] コミットメッセージを生成する
- [ ] MCP利用可能性をチェックする
- [ ] Git MCP経由でコミット実行（または Bashフォールバック）
- [ ] コミット結果を確認する
- [ ] ユーザーに次のアクションを案内する

## このフェーズで絶対にやってはいけないこと

- 実装コードを変更すること（コミットのみ）
- テストコードを変更すること
- 品質チェックをスキップすること
- コミット前に変更内容を十分に確認しないこと

## ワークフロー

### 1. 準備フェーズ

まず、TDDドキュメントと変更内容を確認してください：

```bash
# 最新のTDDドキュメントを検索
ls -t docs/202*.md 2>/dev/null | head -1

# TDDドキュメントの読み込み
# Read docs/YYYYMMDD_hhmm_<機能名>.md
```

TDDドキュメントから以下の情報を抽出してください：

1. **機能名**: コミットメッセージのプレフィックスに使用
2. **実装概要**: コミットメッセージの本文に使用
3. **変更ファイル**: コミット対象の確認

### 2. Git状態確認フェーズ

Gitの状態を確認してください：

```bash
# Git状態確認
git status

# ブランチ確認
git branch --show-current

# 変更の差分確認
git diff --stat

# ステージング状態確認
git diff --cached --stat
```

**確認事項**:
- [ ] 変更ファイルがTDDドキュメントの対象ファイルと一致
- [ ] 意図しない変更が含まれていない
- [ ] 正しいブランチにいる

**問題がある場合**:
```
警告: 以下の問題を確認してください：
- 意図しない変更: XXX
- ブランチ: YYY (期待: ZZZ)

コミットを中断します。
```

### 3. コミット実行フェーズ

#### 3.1 MCP利用可能性チェック

まず、Git MCPが利用可能かチェックしてください：

```bash
# MCP サーバー一覧確認
claude mcp list 2>/dev/null | grep -q "^git "
echo $?  # 0ならMCP利用可能
```

#### 3.2 コミットメッセージ生成

TDDドキュメントの情報を基にコミットメッセージを生成してください：

**フォーマット**:
```
<type>: <機能名の簡潔な説明>

<詳細説明>
- 変更内容1
- 変更内容2

🤖 Generated with [Claude Code](https://claude.com/claude-code)

Co-Authored-By: Claude <noreply@anthropic.com>
```

**type の種類**:
- `feat`: 新機能追加
- `fix`: バグ修正
- `refactor`: リファクタリング
- `test`: テスト追加・修正
- `docs`: ドキュメント更新
- `style`: コードフォーマット
- `chore`: ビルド、設定変更

#### 3.3 コミット実行（MCP優先）

**パターンA: Git MCP利用時**

Git MCPが利用可能な場合、MCP経由でコミットします：

```
注: Git MCPが利用可能です。MCP経由でコミットを実行します。
```

Claude Codeの内部MCPツールを使用してコミットを実行してください。
（Note: MCPツールは自動的に利用可能になります）

コミット実行後、結果を確認：

```bash
# コミット履歴確認
git log --oneline -n 5

# 最新コミットの詳細
git show HEAD --stat
```

**パターンB: Bashフォールバック時**

Git MCPが利用不可の場合、Bashコマンドを使用します：

```
注: Git MCPが利用できません。Bashコマンドでコミットを実行します。
```

```bash
# 変更をステージング
git add .

# コミット実行
git commit -m "$(cat <<'EOF'
<type>: <機能名の簡潔な説明>

<詳細説明>
- 変更内容1
- 変更内容2

🤖 Generated with [Claude Code](https://claude.com/claude-code)

Co-Authored-By: Claude <noreply@anthropic.com>
EOF
)"

# コミット確認
git log --oneline -n 5
```

### 4. 完了フェーズ

コミットが成功したら、以下を伝えてください：

```
COMMITフェーズが完了しました。

コミット情報:
- コミットハッシュ: XXXXXXX
- ブランチ: <ブランチ名>
- 変更ファイル数: XX件

コミットメッセージ:
<type>: <機能名の簡潔な説明>

<詳細説明>

現在のTDDワークフロー:
[完了] INIT (初期化)
[完了] PLAN (計画)
[完了] RED (テスト作成)
[完了] GREEN (実装)
[完了] REFACTOR (リファクタリング)
[完了] REVIEW (品質検証)
[完了] COMMIT (コミット) ← 現在ここ

次のアクション:
1. リモートにプッシュ: git push origin <ブランチ名>
2. プルリクエスト作成（必要に応じて）
3. 次の機能開発: tdd-init から新しいサイクルを開始

TDDワークフローが完了しました。お疲れ様でした！
```

## MCP統合の詳細

### Git MCPの利用

Git MCPが利用可能な場合、以下の機能が自動的に利用されます：

1. **変更のステージング**: MCPツールが自動的に変更をステージング
2. **コミット実行**: MCPツール経由でコミット
3. **エラーハンドリング**: MCP側でエラーハンドリング

### MCPのメリット

- **安全性**: ファイルアクセス制御が適用される
- **監査ログ**: MCP経由の操作はログに記録される
- **統一的な操作**: プロトコルに準拠した標準的な操作

### フォールバックの動作

MCP未利用時は従来のBashコマンドにフォールバックします：

```bash
# フォールバックの判定
if ! claude mcp list 2>/dev/null | grep -q "^git "; then
  echo "Git MCPが利用できません。Bashコマンドを使用します。"
  # Bashコマンドでコミット
fi
```

## エラーハンドリング

### エラー1: コミット対象ファイルが空

**症状**: `nothing to commit, working tree clean`

**対処**:
```
エラー: コミット対象の変更がありません。

確認事項:
- git status で変更があるか確認
- git add でファイルがステージングされているか確認

COMMITフェーズを中断します。
```

### エラー2: コミットメッセージが空

**症状**: コミットメッセージ生成に失敗

**対処**:
```
エラー: コミットメッセージを生成できませんでした。

TDDドキュメントを確認して、機能名と実装概要を再取得します。
```

### エラー3: Git MCPエラー

**症状**: MCP経由のコミットが失敗

**対処**:
```
警告: Git MCP経由のコミットが失敗しました。
Bashフォールバックに切り替えます。

エラー内容:
<MCPエラーメッセージ>
```

自動的にBashフォールバックに切り替えてコミットを再試行してください。

### エラー4: pre-commit hookエラー

**症状**: pre-commit hookでコミットが失敗

**対処**:
```
エラー: pre-commit hookでコミットが失敗しました。

エラー内容:
<hookエラーメッセージ>

対処方法:
1. フックで指摘された問題を修正
2. 再度COMMITフェーズを実行

問題を修正してから、再度コミットしてください。
```

## 制約事項

このフェーズでは、`allowed-tools: Read, Grep, Glob, Bash` が使用可能です。

Git操作のため、**Bashツールが必須**です。

もしユーザーが以下のような依頼をした場合は、**丁寧に拒否**してください：

- 「このファイルも追加して実装して」→ 「COMMITフェーズでは実装を行いません。新しいTDDサイクルで実装しましょう」
- 「コミットメッセージを変更してpush --forceして」→ 「force pushは推奨されません。通常のpushを使用してください」
- 「複数のコミットに分割して」→ 「COMMITフェーズでは単一コミットを作成します」

## Git操作のベストプラクティス

### コミット前の確認事項

- [ ] すべてのテストが通っている
- [ ] 品質チェックが完了している
- [ ] TDDドキュメントの要件を満たしている
- [ ] 意図しない変更が含まれていない
- [ ] コミットメッセージが明確

### コミットメッセージのガイドライン

1. **簡潔**: 1行目は50文字以内
2. **明確**: 何をしたか、なぜしたかを記載
3. **構造化**: type + コロン + 説明
4. **Co-Authored-By**: Claude Codeで生成したことを明示

### リモートへのpush

コミット後、リモートにpushする際は：

```bash
# 現在のブランチをpush
git push origin $(git branch --show-current)

# または
git push
```

## トラブルシューティング

### 問題1: MCPが利用できない

**確認方法**:
```bash
claude mcp list
```

**解決方法**:
```bash
# MCPインストールスクリプト実行
bash scripts/install-mcp.sh

# インストール確認
claude mcp list | grep git
```

### 問題2: コミットが失敗する

**確認方法**:
```bash
# Git状態確認
git status

# 最近のコミット確認
git log --oneline -n 5
```

**解決方法**:
- エラーメッセージを確認
- 変更内容を確認
- 必要に応じてREFACTORフェーズに戻る

### 問題3: ブランチが間違っている

**確認方法**:
```bash
git branch --show-current
```

**解決方法**:
```bash
# 正しいブランチに切り替え
git checkout <正しいブランチ>

# またはブランチ作成
git checkout -b feature/<機能名>
```

## 参考情報

このSkillは、Laravel開発におけるTDDワークフローの最終フェーズです。

- 詳細なワークフロー: README.md参照
- プロジェクト設定: CLAUDE.md参照
- 前のフェーズ: tdd-review Skill（品質検証）
- MCP統合: docs/MCP_INSTALLATION.md参照

### COMMITフェーズの重要性

COMMITフェーズは、TDDサイクルの完了を意味します：

- **品質保証**: テスト・レビュー完了後のコミット
- **追跡可能性**: コミットメッセージで変更の意図を記録
- **自動化**: MCP統合で安全・効率的なコミット

このフェーズを完了すると、安心してリモートにpushできます。

---

*このSkillはClaudeSkillsプロジェクトの一部です*
