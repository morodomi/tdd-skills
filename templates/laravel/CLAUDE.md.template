# [Project Name]

## Project Overview

- **Type**: Web Application
- **Language**: PHP 8.2+
- **Framework**: Laravel 11.0+
- **Test Framework**: PHPUnit / Pest
- **Quality Tools**: PHPStan Level 8, Laravel Pint (PSR-12)

## TDD Workflow

このプロジェクトは厳格なTDD（Test-Driven Development）ワークフローに従います。

**重要**: すべての変更は例外なくTDDサイクルを通してください。

### 7つのフェーズ

すべての機能開発は以下の順序で進めてください：

```
INIT → PLAN → RED → GREEN → REFACTOR → REVIEW → COMMIT
```

1. **INIT（初期化）**: 要件定義とTDDドキュメント作成
2. **PLAN（計画）**: 実装計画とテストケース一覧の作成
3. **RED（失敗するテスト）**: テストコードを先に作成（失敗することを確認）
4. **GREEN（実装）**: テストを通すための最小限の実装
5. **REFACTOR（リファクタリング）**: コード品質の改善（テストは維持）
6. **REVIEW（品質検証）**: テストカバレッジと静的解析の確認
7. **COMMIT（コミット）**: 変更をGitにコミット

### フェーズの開始方法

Claude Codeで以下のコマンドを入力:
- `init` または `/tdd-init`: INITフェーズ開始
- `plan` または `/tdd-plan`: PLANフェーズ開始
- `red` または `/tdd-red`: REDフェーズ開始
- `green` または `/tdd-green`: GREENフェーズ開始
- `refactor` または `/tdd-refactor`: REFACTORフェーズ開始
- `review` または `/tdd-review`: REVIEWフェーズ開始
- `commit` または `/tdd-commit`: COMMITフェーズ開始

### フェーズ自動遷移

各フェーズ完了時に自動的に次のフェーズに遷移します（ユーザー確認なし）。

---

## バグ修正・エラー対応のTDDフロー

エラーや不具合を発見した場合も、**必ずTDDサイクルを通してください**。

### 絶対ルール

> **「エラーを見つけたら、まずテストを書く」**

- ❌ エラーを見つけた → すぐにコードを修正
- ✅ エラーを見つけた → 再現テストを作成 → 修正 → テスト成功確認

**例外はありません。緊急時・本番障害・セキュリティ脆弱性であっても、必ずテストを先に書いてください。**

### バグ修正の手順

1. **INIT**: バグの再現条件を記録（`docs/` に簡易ドキュメント作成）
2. **RED**: バグを再現するテストを作成（失敗することを確認）
3. **GREEN**: バグを修正（テストが通ることを確認）
4. **REFACTOR**: 必要に応じてリファクタリング
5. **REVIEW**: 他の機能への影響確認
6. **COMMIT**: 修正をコミット

### なぜテストが必要か？

1. **再発防止**: 同じバグが再び発生しない
2. **影響範囲の把握**: 他の機能が壊れていないか確認
3. **ドキュメント化**: バグの内容と修正方法が記録される
4. **リファクタリングの安全性**: 将来の変更時に安心
5. **本当に直ったか確認**: 修正が正しいことを証明

---

## AIアシスタントへの厳格な指示

AIアシスタント（Claude、GitHub Copilot等）は、以下のルールを**絶対に**守ってください：

### 1. エラー発見時の対応

ユーザーがエラーや不具合を報告した場合：

❌ **禁止**:
```
修正しました。[修正内容]
```

✅ **必須**:
```
エラーを確認しました。TDDサイクルで対応しましょう。

まず、このエラーを再現するテストを作成します。
テストが失敗することを確認してから、修正を実装します。

1. RED: 再現テストを作成しますか？
```

### 2. コード修正依頼時の対応

ユーザーが「〜を修正して」と依頼した場合：

❌ **禁止**:
```
以下のように修正しました：
[修正コード]
```

✅ **必須**:
```
修正する前に、テストを作成しましょう。

現在の問題を再現するテストケースを作成します。
その後、テストを通すように修正を実装します。

TDDサイクルで進めますか？
```

### 3. 「急いでいる」と言われた場合

ユーザーが「急いでいるから直接修正して」と言った場合：

❌ **禁止**:
```
わかりました。直接修正します。
```

✅ **必須**:
```
急いでいる場合でも、テストを先に書くことで：
- 修正が正しいことを確認できます
- 他の機能を壊していないことを確認できます
- 同じバグの再発を防げます

テストの作成は数分で完了します。
TDDサイクルで進めましょう。

まず再現テストを作成します。
```

### 4. 例外は認めない

以下の状況でも、**必ずTDDサイクルを通してください**：

- 「小さな修正だから」 → ✗ 例外ではない
- 「本番環境で障害発生」 → ✗ テストを先に書く
- 「セキュリティ脆弱性」 → ✗ テストを先に書く
- 「顧客が待っている」 → ✗ テストを先に書く

**すべての変更は、テストファーストで進めてください。**

---

## TDDドキュメント管理

### ドキュメント配置

すべての機能開発・バグ修正は `docs/` ディレクトリにTDDドキュメントを作成してください。

**命名規則**: `docs/YYYYMMDD_hhmm_機能名.md`

**例**:
- `docs/20251105_1430_ユーザー登録機能.md`
- `docs/20251105_1600_バグ修正_ログインエラー.md`

### ドキュメント構成

```markdown
# 機能名: [機能名]

## INIT: 要件定義

### 背景
[なぜこの機能が必要か / バグの発生状況]

### 目標
[何を実現するか / バグをどう修正するか]

## PLAN: 実装計画

### テストケース一覧

#### 実装予定（TODO）
- [ ] TC-01: [テストケース]
- [ ] TC-02: [テストケース]

#### 実装中（WIP）
（現在作業中のテストケース）

#### 実装中に気づいた追加テスト（DISCOVERED）
（実装中に発見した新しいテストケース）

#### 完了（DONE）
- [x] TC-XX: [完了したテストケース]

### アーキテクチャ設計
[実装の設計方針]

## RED: テストコード

[失敗するテストコードの作成]

## GREEN: 実装

[テストを通すための実装]

## REFACTOR: リファクタリング

[コード品質の改善]

## REVIEW: 品質検証

### テスト結果
- カバレッジ: XX%
- 静的解析: エラー0件

### チェックリスト
- [ ] すべてのテストが成功
- [ ] カバレッジ目標達成
- [ ] 静的解析エラー0件
- [ ] コーディング規約準拠

## COMMIT: コミット情報

コミットハッシュ: [hash]
```

---

## テストリストの管理

### 重要な原則

実装中に新しいテストケースや問題に気づいた場合：

1. **今すぐ対応しない**
2. **テストリストに追加する**
3. **今のタスクに集中する**
4. **次のサイクルで対応する**

### 追加方法

TDDドキュメントの「実装中に気づいた追加テスト（DISCOVERED）」セクションに追記：

```markdown
### 実装中に気づいた追加テスト（DISCOVERED）
- [ ] TC-XX: [新しいテストケース]（[フェーズ]中に気づいた - Priority: [High/Medium/Low]）
```

**例**:
```markdown
- [ ] TC-04: パスワードリセット機能（GREEN中に気づいた - Priority: High）
- [ ] TC-05: セッション有効期限（REFACTOR中に気づいた - Priority: Medium）
```

### 優先度の判断

- **Priority: High**: 今実装中の機能に直接影響（次のサイクルで対応）
- **Priority: Medium**: 関連性が高い（近いうちに対応）
- **Priority: Low**: 将来的に必要（時間があれば対応）

### 複数セッションにまたがる作業（長期タスク管理）

TDDサイクルが複数セッションにまたがる場合の状態追跡方法：

**状態管理の方法**:
- TDDドキュメントの `phase` フィールドで現在位置を追跡
- Progress Log で各セッションの作業を記録
- Git commit で中間状態を保存

**セッション再開時の手順**:
1. 最新のTDDドキュメントを確認（`ls -t docs/202*.md | head -1`）
2. ドキュメント冒頭の `phase` フィールドで現在のフェーズを確認
3. Progress Log で前回の作業内容を確認
4. 該当フェーズのコマンドを実行（例: `green`、`refactor`）

**例**: セッション再開時
```
前回のセッションから再開します。

TDDドキュメント: docs/20251105_1430_ユーザー登録機能.md
現在のフェーズ: GREEN
前回の作業: テストケースTC-01〜TC-03のテスト作成完了

GREENフェーズを継続しますか？
```

---

## 各フェーズでの注意点

### INIT フェーズ
- TDDドキュメントを作成
- 要件を明確化
- 実装コードは書かない

### PLAN フェーズ
- テストケース一覧を作成
- アーキテクチャ設計を記述
- 実装コードは書かない

### RED フェーズ
- テストコードを先に作成
- テストが失敗することを確認
- 実装コードは書かない

### GREEN フェーズ
- テストを通すための最小限の実装
- YAGNI原則（必要になるまで実装しない）
- ハードコードも許容

### REFACTOR フェーズ
- コード品質を改善
- テストは維持（すべて成功し続けること）
- 重複排除、命名改善、構造改善

### REVIEW フェーズ
- テストカバレッジ確認
- 静的解析実行
- コーディング規約チェック
- すべての品質基準を満たす

### COMMIT フェーズ
- テストリストの状態を記録
- わかりやすいコミットメッセージ
- 次のサイクルへの引き継ぎ

---

## フェーズ遷移のルール

- 各フェーズは順番に実行する（スキップ禁止）
- 前のフェーズが完了するまで次に進まない
- REVIEW フェーズで品質基準を満たさない場合は REFACTOR に戻る
- **どんな理由があっても、REDフェーズ（テスト作成）をスキップしてはいけない**

---

## Quality Standards

このプロジェクトは以下の品質基準を遵守します。

### テストカバレッジ

- **目標**: 90%以上
- **最低ライン**: 80%
- **測定**: `php artisan test --coverage` または `vendor/bin/pest --coverage`

### 静的解析

- **ツール**: PHPStan
- **レベル**: Level 8（最高レベル）
- **エラー許容**: 0件
- **実行**: `vendor/bin/phpstan analyse`

### コーディング規約

- **ツール**: Laravel Pint
- **実行チェック**: `./vendor/bin/pint --test`
- **自動修正**: `./vendor/bin/pint`
- **規約**: PSR-12

### テスト形式

- **テスト構造**: `#[Test]` 属性形式（PHPUnit / Pest）
- **意図の明確化**: Given/When/Then/And コメントで意図を明確化
- **テスト分離**: Unit/Feature テストを適切に分離

---

## Testing Guidelines

### テストディレクトリ構造

```
tests/
├── Feature/           # 機能テスト（HTTP、コマンド、複数クラスの統合）
│   ├── Auth/         # 認証機能
│   ├── Api/          # API機能
│   └── *Test.php     # 機能テスト
├── Unit/              # 純粋なロジック（単一クラス、外部依存なし）
│   ├── Models/       # Eloquentモデル
│   ├── Services/     # ビジネスロジック
│   └── *Test.php     # ユニットテスト
└── Pest.php           # Pest設定（オプション）
```

### テストの選択

#### ユニットテスト（tests/Unit/）
- 単一クラスのロジックテスト
- 外部依存なし（データベース、HTTP、ファイルシステム等を使わない）
- 高速な実行
- モック/スタブを使用

#### 機能テスト（tests/Feature/）
- HTTP リクエスト/レスポンスのテスト
- 複数クラスの統合テスト
- データベース、キュー、ストレージ等を使用
- 実環境に近い検証

---

## Available Commands

### テスト実行

```bash
# すべてのテスト
php artisan test
# または
vendor/bin/pest

# Unitテストのみ
php artisan test --testsuite=Unit
# または
vendor/bin/pest --testsuite=Unit

# Featureテストのみ
php artisan test --testsuite=Feature
# または
vendor/bin/pest --testsuite=Feature

# カバレッジ付き
php artisan test --coverage
# または
vendor/bin/pest --coverage
```

### 静的解析

```bash
# 静的解析実行
vendor/bin/phpstan analyse
```

### コーディング規約

```bash
# チェックのみ
./vendor/bin/pint --test

# 自動修正
./vendor/bin/pint
```

### すべてのチェック

```bash
# すべての品質チェック（まとめて実行）
composer check
```

---

## Commit Guidelines

### コミットメッセージ形式

```
feat: 新機能を追加
fix: バグ修正
docs: ドキュメント更新
refactor: リファクタリング
test: テスト追加・修正
chore: ビルド、補助ツール等の変更
```

### 例

```bash
git commit -m "feat: ユーザー認証機能を実装"
git commit -m "fix: パスワードバリデーションのバグを修正"
git commit -m "test: ログイン機能のテストケース追加"
```

---

## Development Workflow Example

```
1. Claude Codeで「init」と入力
   → TDDドキュメント（docs/YYYYMMDD_hhmm_機能名.md）が作成される

2. PLANフェーズで実装計画とテストケースを定義
   → 自動的にREDフェーズへ遷移

3. REDフェーズでテスト作成
   → tests/Unit/Services/UserServiceTest.php
   → tests/Feature/Auth/LoginTest.php
   → 自動的にGREENフェーズへ遷移

4. GREENフェーズで最小限の実装
   → app/Services/UserService.php
   → app/Http/Controllers/Auth/LoginController.php
   → 自動的にREFACTORフェーズへ遷移

5. REFACTORフェーズでリファクタリング
   → コードを改善
   → 自動的にREVIEWフェーズへ遷移

6. REVIEWフェーズで品質チェック
   → 静的解析: 0 errors
   → カバレッジ: 95%
   → コーディング規約: OK
   → 自動的にCOMMITフェーズへ遷移

7. COMMITフェーズでコミット
   → git add .
   → git commit -m "feat: ユーザー認証機能実装"
```

---

## Notes for Claude Code

### メタルール

- コードの動作、ファイル場所、システム状態について不確実な場合は**推測せず、ユーザーに明確化を求める**
- 「おそらく〜」「〜だと思います」などの曖昧な表現を避ける
- 絶対に必要でない限り、新規ファイルを作成しない
- **既存ファイルの編集を新規作成より優先する**

### 出力フォーマット制御

CLIでの可読性を考慮し、以下のガイドラインに従ってください：

- **マークダウン過多を避ける**: 過度な装飾（多重見出し、複雑な表）は控える
- **長いコードブロックは分割**: 50行以上のコードは分割して説明を挟む
- **表形式は簡潔に**: 5列以下を推奨。複雑な表はリスト形式に変換
- **散文形式の活用**: 箇条書きより自然な文章が適切な場合もある

### 開発での重要原則

1. **テストファースト**: 実装前にテストを書く
2. **最小限の実装**: テストを通すための最小限の実装
3. **リファクタリング**: テストが通った後にコードを改善
4. **品質基準の遵守**: 静的解析、カバレッジ、コーディング規約
5. **意図の明確化**: Given/When/Then/And コメントで意図を明確化

### Laravel固有の注意事項

- **Eloquent**: N+1問題を回避（Eager Loading使用）
- **セキュリティ**: CSRF保護、XSS対策、SQLインジェクション対策
- **バリデーション**: FormRequestを使用した入力検証
- **認可**: Policyを使用した権限管理
- **キュー**: 重い処理は非同期処理に
- **キャッシュ**: 頻繁にアクセスするデータはキャッシュ活用

---

## Language/Framework Specific Examples

> **注意**: このセクションの例示内容は、Claudeの実際の動作に影響します。
> 例を変更する場合は、意図した動作になるか確認してください。

### Laravel + PHPUnit/Pest

```php
// tests/Unit/Services/MathServiceTest.php
use PHPUnit\Framework\TestCase;
use PHPUnit\Framework\Attributes\Test;

class MathServiceTest extends TestCase
{
    #[Test]
    public function adds_two_numbers(): void
    {
        // Given: 2つの数値
        $a = 1;
        $b = 2;

        // When: 足し算を実行
        $result = app(MathService::class)->add($a, $b);

        // Then: 正しい結果を返す
        $this->assertSame(3, $result);
    }
}
```

### Laravel + Pest

```php
// tests/Unit/Services/MathServiceTest.php
use App\Services\MathService;

test('adds two numbers', function () {
    // Given: 2つの数値
    $a = 1;
    $b = 2;

    // When: 足し算を実行
    $result = app(MathService::class)->add($a, $b);

    // Then: 正しい結果を返す
    expect($result)->toBe(3);
});
```

### Feature Test Example

```php
// tests/Feature/Auth/LoginTest.php
use Illuminate\Foundation\Testing\RefreshDatabase;

uses(RefreshDatabase::class);

test('user can login with valid credentials', function () {
    // Given: 登録済みのユーザー
    $user = User::factory()->create([
        'email' => 'test@example.com',
        'password' => bcrypt('password'),
    ]);

    // When: 正しい認証情報でログイン
    $response = $this->post('/login', [
        'email' => 'test@example.com',
        'password' => 'password',
    ]);

    // Then: ログイン成功し、ダッシュボードにリダイレクト
    $response->assertRedirect('/dashboard');
    $this->assertAuthenticated();
});
```

---

### ユーザーへの選択肢提示ルール

ユーザーに選択を求める際は、**必ず以下の形式**で提示してください：

#### 必須要素

1. **推奨度**: ★（星）5段階で表現（★☆☆☆☆ ～ ★★★★★）
2. **理由**: 各選択肢を推奨する/しない理由を明記

#### 提示形式

```
選択肢:
1. [推奨★★★★★] [選択肢の内容]
   理由: [この選択肢を強く推奨する理由]

2. [推奨★★★★☆] [選択肢の内容]
   理由: [この選択肢の理由・メリット]

3. [推奨★★★☆☆] [選択肢の内容]
   理由: [中立的・状況次第の理由]

4. [推奨★★☆☆☆] [選択肢の内容]
   理由: [あまり推奨しない理由・デメリット]

どうしますか？
```

#### 推奨度の目安

- **★★★★★ (強く推奨)**:
  - 95%以上のケースで最適
  - 最も一般的で適切な選択肢
  - リスクが低く、効率的
  - 初心者でも安全

- **★★★★☆ (推奨)**:
  - 70-94%のケースで最適
  - 一般的に良い選択肢
  - 条件が揃えば最適
  - 実績がある

- **★★★☆☆ (中立・状況次第)**:
  - 50-69%のケースで有効
  - メリットとデメリットが半々
  - 特定の条件下で有効
  - 状況によっては最適

- **★★☆☆☆ (あまり推奨しない)**:
  - 30-49%のケースで有効
  - デメリットが多い
  - リスクや手間が大きい
  - 限定的な状況でのみ有効

- **★☆☆☆☆ (非推奨)**:
  - 30%未満のケースでのみ有効
  - 特殊なケースのみ
  - 他の選択肢が使えない場合のみ
  - 避けるべき

#### 例1: Overviewドキュメントが存在しない場合

```
選択肢:
1. [推奨★★★★★] このまま進める（CLAUDE.md/README.mdで十分な情報がある）
   理由: 小規模プロジェクトでは過剰な構造化は不要。95%のケースでこれが最適

2. [推奨★★★★☆] PLANフェーズで必要なら作成する
   理由: 実際に必要性を感じてから作成する方が効率的。柔軟な対応

3. [推奨★★☆☆☆] 今すぐOverview docを作成する（時間がかかる）
   理由: 時間がかかる。大規模化が確実な場合のみ有効

どうしますか？
```

#### 例2: 既存のTDDサイクルが進行中の場合

```
選択肢:
1. [推奨★★★★★] 既存のTDDサイクルを継続する（INITは不要）
   理由: 複数サイクルを並行すると混乱しやすい。完了してから新規開始が安全

2. [推奨★★☆☆☆] 新しいサイクルを開始する（既存サイクルと並行開発）
   理由: 独立した機能で影響がない場合のみ有効。管理コストが増加

どうしますか？
```

#### 例3: テストフレームワーク選択（4個の選択肢）

```
選択肢:
1. [推奨★★★★★] PHPUnit + Pest
   理由: モダンな記法とPHPUnitの安定性の両立。Laravelプロジェクトで最適

2. [推奨★★★★☆] PHPUnit のみ
   理由: 実績豊富で安定。チームが慣れている場合に推奨

3. [推奨★★★☆☆] Pest のみ
   理由: モダンで読みやすいが、PHPUnitの機能が必要な場合は不足

4. [推奨★★☆☆☆] Codeception
   理由: E2Eテスト向け。単体・統合テストには過剰な機能

どうしますか？
```

#### 禁止事項

❌ **推奨度や理由なしの選択肢提示**:
```
選択肢:
1. このまま進める
2. Overview docを作成する
3. PLANフェーズで作成する
```

✅ **正しい提示方法**（上記の例参照）

---

*最終更新: [YYYY-MM-DD]*
*ClaudeSkills Version: [バージョン]*
