#!/usr/bin/env bash

################################################################################
# Test Agent Command - Execution Flow Tests
################################################################################

set -e

# プロジェクトルートを取得
PROJECT_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/../.." && pwd)"

# 色定義
GREEN='\033[0;32m'
RED='\033[0;31m'
NC='\033[0m' # No Color

# テスト結果カウンター
PASS_COUNT=0
FAIL_COUNT=0

# テスト結果表示
pass() {
    echo -e "${GREEN}✓ PASS${NC}: $1"
    ((PASS_COUNT++)) || true
}

fail() {
    echo -e "${RED}✗ FAIL${NC}: $1"
    ((FAIL_COUNT++)) || true
}

echo "=========================================="
echo "Test Agent Command - Execution Flow Tests"
echo "=========================================="
echo ""

COMMAND_FILE="$PROJECT_ROOT/.claude/commands/test-agent.md"

################################################################################
# TC-12: カバレッジレポート解析ロジックが記述されている
################################################################################
echo "TC-12: カバレッジレポート解析ロジックが記述されている"

if [ -f "$COMMAND_FILE" ]; then
    if grep -qE "Lines:|カバレッジ.*解析|coverage.*report|レポート.*解析" "$COMMAND_FILE"; then
        pass "TC-12: カバレッジレポート解析ロジックが記述されている"
    else
        fail "TC-12: カバレッジレポート解析ロジックが見つからない"
    fi
else
    fail "TC-12: ファイルが存在しない"
fi

################################################################################
# TC-13: コアロジック優先判定の指示がある
################################################################################
echo "TC-13: コアロジック優先判定の指示がある（Service, Controller等）"

if [ -f "$COMMAND_FILE" ]; then
    if grep -qE "Service|Controller|コアロジック|優先.*判定|優先度" "$COMMAND_FILE"; then
        pass "TC-13: コアロジック優先判定の指示がある"
    else
        fail "TC-13: コアロジック優先判定の指示が見つからない"
    fi
else
    fail "TC-13: ファイルが存在しない"
fi

################################################################################
# TC-14: 既存テスト構造確認の指示がある
################################################################################
echo "TC-14: 既存テスト構造確認の指示がある（Read/Grep tool使用）"

if [ -f "$COMMAND_FILE" ]; then
    if grep -qE "既存.*テスト|テスト.*構造|Read|Grep|find.*tests" "$COMMAND_FILE"; then
        pass "TC-14: 既存テスト構造確認の指示がある"
    else
        fail "TC-14: 既存テスト構造確認の指示が見つからない"
    fi
else
    fail "TC-14: ファイルが存在しない"
fi

################################################################################
# TC-15: テスト追加後のカバレッジ再測定指示がある
################################################################################
echo "TC-15: テスト追加後のカバレッジ再測定指示がある"

if [ -f "$COMMAND_FILE" ]; then
    if grep -qE "再測定|カバレッジ.*再|再.*カバレッジ|after.*coverage" "$COMMAND_FILE"; then
        pass "TC-15: テスト追加後のカバレッジ再測定指示がある"
    else
        fail "TC-15: カバレッジ再測定指示が見つからない"
    fi
else
    fail "TC-15: ファイルが存在しない"
fi

################################################################################
# TC-16: 成功判定条件が明確（+5%〜10%、上限90%）
################################################################################
echo "TC-16: 成功判定条件が明確（+5%〜10%、上限90%）"

if [ -f "$COMMAND_FILE" ]; then
    # 5%〜10%の言及、または90%の上限言及をチェック
    if grep -qE "5%|10%|90%|目標.*カバレッジ|成功.*判定" "$COMMAND_FILE"; then
        pass "TC-16: 成功判定条件が明確"
    else
        fail "TC-16: 成功判定条件が見つからない"
    fi
else
    fail "TC-16: ファイルが存在しない"
fi

################################################################################
# TC-17: PRスコープ制限の指示がある（10ファイル未満）
################################################################################
echo "TC-17: PRスコープ制限の指示がある（10ファイル未満）"

if [ -f "$COMMAND_FILE" ]; then
    if grep -qE "10.*ファイル|ファイル.*10|スコープ.*制限|制限.*ファイル" "$COMMAND_FILE"; then
        pass "TC-17: PRスコープ制限の指示がある"
    else
        fail "TC-17: PRスコープ制限の指示が見つからない"
    fi
else
    fail "TC-17: ファイルが存在しない"
fi

################################################################################
# テスト結果サマリー
################################################################################
echo ""
echo "=========================================="
echo "Test Results Summary"
echo "=========================================="
echo -e "PASS: ${GREEN}${PASS_COUNT}${NC}"
echo -e "FAIL: ${RED}${FAIL_COUNT}${NC}"
echo ""

if [ $FAIL_COUNT -eq 0 ]; then
    echo -e "${GREEN}All tests passed!${NC}"
    exit 0
else
    echo -e "${RED}Some tests failed.${NC}"
    exit 1
fi
