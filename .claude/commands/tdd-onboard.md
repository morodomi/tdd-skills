---
description: install.sh実行後の対話的セットアップ。プロジェクト分析 + CLAUDE.md生成 + 初期チケット発行
---

# TDD Onboard Command

既存プロジェクトに ClaudeSkills TDD 環境をセットアップします。

## 使用方法

```bash
/tdd-onboard
```

install.sh 実行後に実行してください。

---

## 実行フロー概要

```
Step 1: プロジェクト分析（フレームワーク/パッケージマネージャ/テストツール検出）
  ↓
Step 2: 検出結果確認（AskUserQuestion で対話的に確認）
  ↓
Step 3: docs/ 構造作成（docs/cycles/, docs/README.md）
  ↓
Step 4: CLAUDE.md 生成（テンプレートから変数置換）
  ↓
Step 5: 初期チケット発行（project-setup Cycle doc）
  ↓
Step 6: Next Steps 表示
```

---

## Step 1: プロジェクト分析

### 1.1 フレームワーク検出

Glob ツールで以下のファイルを確認し、フレームワークを検出してください:

| 検出対象 | フレームワーク |
|---------|--------------|
| `artisan` | Laravel |
| `app.py` または `wsgi.py` | Flask |
| `manage.py` + django依存 | Django |
| `wp-config.php` | WordPress |
| 上記以外 | Generic |

**検出ロジック**:

```bash
# Laravel検出
Glob: artisan
→ 存在すれば Laravel

# Flask検出
Glob: app.py, wsgi.py
Grep: "flask" in pyproject.toml
→ いずれか該当すれば Flask

# Django検出
Glob: manage.py
Grep: "django" in requirements.txt or pyproject.toml
→ 両方該当すれば Django

# WordPress検出
Glob: wp-config.php
→ 存在すれば WordPress
```

### 1.2 パッケージマネージャ検出

| 検出対象 | パッケージマネージャ |
|---------|-------------------|
| `composer.json` | Composer (PHP) |
| `poetry.lock` | Poetry (Python) |
| `uv.lock` | uv (Python) |
| `pyproject.toml` のみ | ユーザー確認 |
| `package.json` | npm/yarn/pnpm |

### 1.3 テストツール検出

フレームワークに基づいてデフォルトを設定:

| フレームワーク | テストツール | カバレッジコマンド | 静的解析 | フォーマッター |
|--------------|-------------|------------------|---------|--------------|
| Laravel | PHPUnit/Pest | `php artisan test --coverage` | PHPStan | Pint |
| Flask | pytest | `pytest --cov=app --cov-report=term-missing` | mypy | black |
| Django | pytest | `pytest --cov` | mypy | black |
| WordPress | PHPUnit | `vendor/bin/phpunit --coverage-text` | PHPStan | WPCS |
| Generic | 検出/確認 | ユーザー指定 | 検出/確認 | 検出/確認 |

### 1.4 既存テスト構造確認

Glob ツールで既存のテスト構造を確認:

```bash
# PHP テスト
Glob: tests/**/*Test.php
Glob: tests/Unit/**/*.php
Glob: tests/Feature/**/*.php

# Python テスト
Glob: tests/**/*_test.py
Glob: tests/**/test_*.py
Glob: tests/unit/**/*.py
Glob: tests/integration/**/*.py
```

---

## Step 2: 検出結果確認

AskUserQuestion ツールで検出結果を確認してください。

### 確認項目

1. **フレームワーク**: 検出結果が正しいか
2. **パッケージマネージャ**: 検出結果が正しいか（poetry/uv の判断）
3. **既存 CLAUDE.md**: 上書き or マージの確認

**AskUserQuestion 例**:

```yaml
questions:
  - question: "検出したフレームワークは正しいですか？"
    header: "Framework"
    options:
      - label: "${DETECTED_FRAMEWORK}"
        description: "自動検出された結果を使用"
      - label: "Laravel"
        description: "PHP Laravel フレームワーク"
      - label: "Flask"
        description: "Python Flask フレームワーク"
      - label: "Django"
        description: "Python Django フレームワーク"
    multiSelect: false
```

---

## Step 3: docs/ 構造作成

### 3.1 ディレクトリ作成

Bash ツールで以下を実行:

```bash
mkdir -p docs/cycles
```

### 3.2 docs/README.md 作成

docs/README.md が存在しない場合、Write ツールで作成:

```markdown
# Documentation Index

## TDD サイクル

サイクルドキュメントは `docs/cycles/` に格納されています。

**命名規則**: `YYYYMMDD_HHMM_機能名.md`

## 最新のサイクル

| 日時 | 機能名 | フェーズ |
|------|--------|---------|
| （/tdd-onboard で自動更新） | | |

## ドキュメント一覧

- 設計・調査は `docs/` 直下に格納
- TDD サイクルは `docs/cycles/` に格納
```

---

## Step 4: CLAUDE.md 生成

### 4.1 既存 CLAUDE.md の確認

既存の CLAUDE.md がある場合:
1. バックアップ作成: `CLAUDE.md.backup`
2. ユーザーに上書き確認

### 4.2 テンプレートから生成

検出結果に基づいて変数を置換し、CLAUDE.md を生成:

```markdown
# ${PROJECT_NAME} - TDD Workflow

## Project Overview

**Framework**: ${FRAMEWORK}
**Package Manager**: ${PACKAGE_MANAGER}

---

## Tech Stack

- **Framework**: ${FRAMEWORK}
- **Package Manager**: ${PACKAGE_MANAGER}
- **Test Tool**: ${TEST_TOOL}
- **Coverage**: ${COVERAGE_COMMAND}
- **Static Analysis**: ${STATIC_ANALYSIS}
- **Formatter**: ${FORMATTER}

---

## Quality Standards

### テストカバレッジ
- 目標: 90%以上
- 最低ライン: 80%
- 測定: `${COVERAGE_COMMAND}`

### 静的解析
- **${STATIC_ANALYSIS}** 必須
- エラー許容: 0件
- 実行: `${STATIC_ANALYSIS_COMMAND}`

### コードフォーマット
- **${FORMATTER}** 準拠
- 実行: `${FORMATTER_COMMAND}`

---

## TDD Workflow

7つのフェーズ:

```
INIT → PLAN → RED → GREEN → REFACTOR → REVIEW → COMMIT
```

1. **INIT**: Cycle doc 作成
2. **PLAN**: スコープ定義、テストリスト作成
3. **RED**: 失敗するテスト作成
4. **GREEN**: 最小実装
5. **REFACTOR**: リファクタリング
6. **REVIEW**: コードレビュー
7. **COMMIT**: コミット + ドキュメント更新

詳細は Skills を参照してください。

---

## Project Structure

```
${PROJECT_STRUCTURE}
```

---

## Commands

- `/tdd-onboard`: 初期セットアップ（このコマンド）
- `/test-agent`: カバレッジ向上
- `/code-review`: コードレビュー

---

*Generated by /tdd-onboard*
```

---

## Step 5: 初期チケット発行

Write ツールで `docs/cycles/${TIMESTAMP}_0000_project-setup.md` を作成:

```markdown
---
feature: setup
cycle: project-setup-001
phase: INIT
created: ${DATE}
updated: ${DATE}
---

# プロジェクト TDD セットアップ

## やりたいこと

プロジェクトの TDD 環境を確認し、品質基準を満たす状態を把握する。

---

## Scope Definition

### 確認項目

1. 既存テストが全て通過するか
2. 現在のカバレッジ率
3. 静的解析エラー数
4. コードフォーマット状態

---

## 実行コマンド

```bash
# テスト実行
${TEST_COMMAND}

# カバレッジ測定
${COVERAGE_COMMAND}

# 静的解析
${STATIC_ANALYSIS_COMMAND}

# フォーマットチェック
${FORMATTER_CHECK_COMMAND}
```

---

## Test List

### 実装予定（TODO）

- [ ] 既存テストが全て通過する
- [ ] 現在のカバレッジ率を記録: ___%
- [ ] 静的解析エラー数を記録: ___件
- [ ] コードフォーマット: OK / NG

### 完了（DONE）

（なし）

---

## Progress Log

### ${DATE} - INIT phase
- /tdd-onboard で自動生成
- 品質基準確認を開始
```

---

## Step 6: Next Steps 表示

セットアップ完了後、以下を表示:

```
==========================================
TDD 環境セットアップ完了
==========================================

検出結果:
  Framework: ${FRAMEWORK}
  Package Manager: ${PACKAGE_MANAGER}
  Test Tool: ${TEST_TOOL}

作成されたファイル:
  - CLAUDE.md（プロジェクト設定）
  - docs/cycles/${TIMESTAMP}_0000_project-setup.md（初期チケット）
  - docs/README.md（ドキュメント索引）

次のステップ:

1. 初期チケットで品質状態を確認:
   cat docs/cycles/${TIMESTAMP}_0000_project-setup.md

2. テスト実行:
   ${TEST_COMMAND}

3. カバレッジ測定:
   ${COVERAGE_COMMAND}

4. 新機能開発時:
   "tdd-init 機能名" と入力

5. Skills の使い方:
   - ux-design: UX 設計時に使用
   - tdd-*: 各 TDD フェーズで自動適用

詳細は CLAUDE.md を参照してください。
==========================================
```

---

## 変数一覧

| 変数名 | 説明 | 例 |
|--------|------|-----|
| `${PROJECT_NAME}` | プロジェクト名（ディレクトリ名） | my-app |
| `${FRAMEWORK}` | フレームワーク | Laravel, Flask |
| `${PACKAGE_MANAGER}` | パッケージマネージャ | composer, poetry, uv |
| `${TEST_TOOL}` | テストツール | PHPUnit, pytest |
| `${TEST_COMMAND}` | テスト実行コマンド | php artisan test |
| `${COVERAGE_COMMAND}` | カバレッジ測定コマンド | php artisan test --coverage |
| `${STATIC_ANALYSIS}` | 静的解析ツール | PHPStan, mypy |
| `${STATIC_ANALYSIS_COMMAND}` | 静的解析コマンド | vendor/bin/phpstan analyse |
| `${FORMATTER}` | フォーマッター | Pint, black |
| `${FORMATTER_COMMAND}` | フォーマットコマンド | vendor/bin/pint |
| `${FORMATTER_CHECK_COMMAND}` | フォーマットチェック | vendor/bin/pint --test |
| `${TIMESTAMP}` | タイムスタンプ | 20251126_1540 |
| `${DATE}` | 日付 | 2025-11-26 |
| `${PROJECT_STRUCTURE}` | プロジェクト構造 | （自動検出） |

---

## エラーハンドリング

| 状況 | 対応 |
|------|------|
| フレームワーク検出失敗 | ユーザーに確認（AskUserQuestion） |
| 既存 CLAUDE.md あり | バックアップ + 上書き確認 |
| docs/ 既存 | マージ or 上書き確認 |
| poetry/uv 判別不可 | ユーザーに確認 |
