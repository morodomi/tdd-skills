# TDD Onboard Reference

詳細なワークフローとテンプレート。

## Step 1: プロジェクト分析

### 1.1 フレームワーク検出

| 検出対象 | フレームワーク |
|---------|--------------|
| `artisan` | Laravel |
| `app.py` または `wsgi.py` | Flask |
| `manage.py` + django依存 | Django |
| `wp-config.php` | WordPress |
| 上記以外 | Generic |

### 1.2 パッケージマネージャ検出

| 検出対象 | パッケージマネージャ |
|---------|-------------------|
| `composer.json` | Composer (PHP) |
| `poetry.lock` | Poetry (Python) |
| `uv.lock` | uv (Python) |
| `package.json` | npm/yarn/pnpm |

### 1.3 テストツール検出

| フレームワーク | テストツール | カバレッジ | 静的解析 | フォーマッター |
|--------------|-------------|----------|---------|--------------|
| Laravel | PHPUnit/Pest | `php artisan test --coverage` | PHPStan | Pint |
| Flask | pytest | `pytest --cov` | mypy | black |
| Django | pytest | `pytest --cov` | mypy | black |
| WordPress | PHPUnit | `phpunit --coverage-text` | PHPStan | WPCS |

---

## Step 3: docs/ 構造

### docs/README.md テンプレート

```markdown
# Documentation Index

## プロジェクト状況

現在の状況は [STATUS.md](STATUS.md) を参照。

## TDD サイクル

サイクルドキュメントは `docs/cycles/` に格納されています。

**命名規則**: `YYYYMMDD_HHMM_機能名.md`

## ドキュメント一覧

- 設計・調査は `docs/` 直下に格納
- TDD サイクルは `docs/cycles/` に格納
```

### docs/STATUS.md テンプレート

```markdown
# Project Status

最終更新: ${DATE}

## 進行中

なし

## バックログ

GitHub Issues を参照: `gh issue list`

## 最近完了

なし

---

*このファイルは tdd-commit で自動更新されます*
```

---

## Step 4: CLAUDE.md 生成

### マージ戦略

| セクション | 戦略 |
|-----------|------|
| Overview | 既存を保持 |
| Tech Stack | 新規で上書き |
| Quick Commands | 新規で上書き |
| TDD Workflow | 新規で上書き |
| Quality Standards | 新規で上書き |
| Project Structure | 既存を保持 |
| カスタムセクション | 既存を保持 |

### CLAUDE.md テンプレート

```markdown
# ${PROJECT_NAME}

## Overview

[プロジェクトの目的を2-3文で記述]

---

## Tech Stack

| Layer | Language | Framework | Plugin |
|-------|----------|-----------|--------|
| Backend | ${BACKEND_LANGUAGE} | ${BACKEND_FRAMEWORK} | ${BACKEND_PLUGIN} |
| Frontend | ${FRONTEND_LANGUAGE} | ${FRONTEND_FRAMEWORK} | ${FRONTEND_PLUGIN} |

- **Test**: ${TEST_TOOL}
- **Static Analysis**: ${STATIC_ANALYSIS}
- **Formatter**: ${FORMATTER}

---

## Quick Commands

\`\`\`bash
# テスト
${TEST_COMMAND}

# カバレッジ
${COVERAGE_COMMAND}

# 静的解析
${STATIC_ANALYSIS_COMMAND}

# フォーマット
${FORMATTER_COMMAND}
\`\`\`

---

## TDD Workflow

すべての機能開発・バグ修正はTDDサイクルを通す。

\`\`\`
INIT → PLAN → RED → GREEN → REFACTOR → REVIEW → COMMIT
\`\`\`

**絶対ルール**: エラーを見つけたら、まずテストを書く

---

## Quality Standards

| 指標 | 目標 |
|------|------|
| カバレッジ | 90%以上（最低80%） |
| 静的解析 | エラー0件 |
| フォーマット | 規約準拠 |

---

## Claude Code Configuration

| ディレクトリ | 内容 |
|-------------|------|
| .claude/rules/ | 常時適用ルール |
| .claude/hooks/ | 推奨Hooks設定 |

### Rules

- git-safety.md - Git安全規則
- security.md - セキュリティチェック
- git-conventions.md - Git規約

### Hooks

- recommended.md - 推奨フック設定

---

## Project Structure

\`\`\`
${PROJECT_STRUCTURE}
\`\`\`

---

*Generated by tdd-onboard*
```

---

## Step 5: 階層CLAUDE.md推奨

### 制約事項（Context肥大化対策）

| 制約 | 基準 |
|------|------|
| 深さ制限 | 第1階層まで（tests/, src/, docs/） |
| サイズ制限 | 各30-50行以内 |
| 合計予算 | 全CLAUDE.md合計 500行以内目安 |

**推奨パターン**:
```
✅ 推奨
project/
├── CLAUDE.md              # 必須: プロジェクト全体
├── tests/CLAUDE.md        # 任意: テスト規約
├── src/CLAUDE.md          # 任意: 実装規約
└── docs/CLAUDE.md         # 任意: ドキュメント規約
```

**非推奨パターン（サブディレクトリは非推奨）**:
```
❌ 非推奨
tests/Unit/CLAUDE.md        # 深すぎる
tests/Feature/CLAUDE.md     # 深すぎる
src/Services/CLAUDE.md      # 深すぎる
```

### tests/CLAUDE.md テンプレート

```markdown
# Tests

## 命名規則

- ファイル: `*Test.php` / `test_*.py`
- メソッド: `test_機能_条件_期待結果()`

## テスト構造

- Given/When/Then形式
- 1テスト1アサーション推奨

## モックパターン

- 外部API: 必ずモック
- DB: トランザクション使用
```

### src/CLAUDE.md テンプレート

```markdown
# Source

## アーキテクチャ

- レイヤー: Controller → Service → Repository
- DI: 必須

## コーディング規約

- 早期リターン推奨
- マジックナンバー禁止
```

### docs/CLAUDE.md テンプレート

```markdown
# Documentation

## ファイル命名

- Cycle doc: `YYYYMMDD_HHMM_機能名.md`
- 調査: `YYYYMMDD_HHMM_内容.md`

## 形式

- Markdown形式
- コードブロックは言語指定必須
```

---

## Step 6: .claude/rules/

### security.md

```markdown
# Security Rules

## コミット前チェック（必須）

1. [ ] ハードコードされた秘密鍵がないか
2. [ ] 入力検証が適切か
3. [ ] SQLインジェクション対策
4. [ ] XSS対策
5. [ ] CSRF保護
6. [ ] 認証・認可確認
7. [ ] レート制限
8. [ ] エラーメッセージが情報漏洩しないか

## 秘密鍵管理

- ハードコード禁止
- 環境変数を使用
- .envファイルは.gitignoreに追加

## 問題発見時

1. 即座に作業停止
2. security-reviewerエージェント使用
3. CRITICAL問題を優先修正
4. 公開された秘密鍵はローテーション
```

### git-safety.md

```markdown
# Git Safety Rules

## 禁止事項

- `--no-verify` の使用禁止
- `main`/`master` への直接push禁止
- `--force` push禁止（force-with-leaseは許可）
- 秘密鍵・認証情報のコミット禁止

## 推奨フロー

1. `develop` or `feature/*` ブランチで作業
2. PR経由で `main` にマージ
3. pre-commit hook を必ず通す

## ブランチ保護

| ブランチ | push | force push | 直接commit |
|---------|------|------------|-----------|
| main    | X    | X          | X         |
| develop | !    | X          | !         |
| feature/* | OK | X          | OK        |
```

### git-conventions.md

```markdown
# Git Conventions

## コミットメッセージ形式

\`\`\`
<type>: <subject>
\`\`\`

## Type一覧

| Type | 説明 | 例 |
|------|------|-----|
| feat | 新機能 | feat: ログイン機能追加 |
| fix | バグ修正 | fix: パスワード検証エラー修正 |
| docs | ドキュメント | docs: README更新 |
| refactor | リファクタリング | refactor: 認証ロジック整理 |
| test | テスト | test: ログインテスト追加 |
| chore | その他 | chore: 依存関係更新 |

## 良いコミットメッセージ

\`\`\`
feat: ユーザーログイン機能

- メールアドレスとパスワードでログイン
- セッション管理

Closes #123
\`\`\`
```

---

## Step 6.5: .claude/hooks/

### recommended.md

```markdown
# Recommended Hooks

~/.claude/settings.json に追加:

\`\`\`json
{
  "hooks": {
    "PreToolUse": [
      {
        "matcher": "Bash",
        "hooks": [
          {
            "type": "command",
            "command": "if echo \"$TOOL_INPUT\" | grep -qF -- '--no-verify'; then echo 'BLOCK: --no-verify is prohibited' >&2; exit 2; fi"
          }
        ]
      }
    ],
    "Stop": [
      {
        "hooks": [
          {
            "type": "command",
            "command": "echo 'Session ended: Remember to run tests'"
          }
        ]
      }
    ]
  }
}
\`\`\`

## 使い方

1. 上記をコピー
2. ~/.claude/settings.json に追加
3. Claude Code再起動

## 注意

- exit 2: ブロック（Claudeにフィードバック）
- exit 0: 許可
- TOOL_INPUT: JSON形式で渡される
```

---

## Step 7: Pre-commit Hook確認

### 検出対象

| ツール | パス |
|--------|------|
| husky | `.husky/pre-commit` |
| native | `.git/hooks/pre-commit` |
| pre-commit framework | `.pre-commit-config.yaml` |

### 推奨メッセージ

**hookなしの場合:**
```
⚠️ Pre-commit hookが設定されていません。

テスト自動実行のため、以下のいずれかを推奨:
- husky: npx husky-init && npm install
- native: cp .git/hooks/pre-commit.sample .git/hooks/pre-commit

詳細: https://typicode.github.io/husky/
```

---

## Step 8: 初期Cycle doc

```markdown
---
feature: setup
cycle: project-setup-001
phase: INIT
created: ${DATE}
updated: ${DATE}
---

# プロジェクト TDD セットアップ

## やりたいこと

プロジェクトの TDD 環境を確認し、品質基準を満たす状態を把握する。

---

## 確認項目

1. 既存テストが全て通過するか
2. 現在のカバレッジ率
3. 静的解析エラー数
4. コードフォーマット状態

---

## Test List

- [ ] 既存テストが全て通過する
- [ ] カバレッジ率を記録: ___%
- [ ] 静的解析エラー数: ___件
- [ ] フォーマット: OK / NG
```

---

## 変数一覧

| 変数名 | 説明 | 例 |
|--------|------|-----|
| `${PROJECT_NAME}` | プロジェクト名 | my-app |
| `${BACKEND_LANGUAGE}` | バックエンド言語 | PHP, Python |
| `${BACKEND_FRAMEWORK}` | バックエンドFW | Laravel, Flask |
| `${BACKEND_PLUGIN}` | バックエンドプラグイン | tdd-php, tdd-flask |
| `${FRONTEND_LANGUAGE}` | フロントエンド言語 | JavaScript, TypeScript |
| `${FRONTEND_FRAMEWORK}` | フロントエンドFW | Alpine.js, Vue |
| `${FRONTEND_PLUGIN}` | フロントエンドプラグイン | tdd-js, tdd-ts |
| `${TEST_TOOL}` | テストツール | PHPUnit, pytest |
| `${TEST_COMMAND}` | テスト実行 | php artisan test |
| `${COVERAGE_COMMAND}` | カバレッジ | php artisan test --coverage |
| `${STATIC_ANALYSIS}` | 静的解析 | PHPStan, mypy |
| `${FORMATTER}` | フォーマッター | Pint, black |

---

## エラーハンドリング

| 状況 | 対応 |
|------|------|
| フレームワーク検出失敗 | AskUserQuestion で確認 |
| 既存 CLAUDE.md あり | バックアップ + マージ確認 |
| poetry/uv 判別不可 | ユーザーに確認 |
