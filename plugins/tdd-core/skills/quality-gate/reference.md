# Quality Gate - Reference

SKILL.mdの詳細情報。必要時のみ参照。

## 対象範囲指定（Step 1）

### 引数パターン

| パターン | 解釈 | コマンド |
|---------|------|---------|
| 引数なし | デフォルト（差分のみ） | `git diff HEAD --name-only` |
| `全部` `--all` `全体` | 全ファイル | プロジェクト内全ソースファイル |
| ディレクトリ名 | 特定ディレクトリ | 指定ディレクトリ内のファイル |

### TC-01: 引数なしで git diff HEAD 対象をチェック

**Given**: 変更ファイルが存在する
```bash
git diff HEAD --name-only  # 出力あり
```

**When**: quality-gate を引数なしで起動

**Then**: git diff HEAD の対象ファイルのみをチェック

### TC-02: 「全部チェックして」で全ファイル対象

**When**: `quality-gate 全部チェックして` または `quality-gate --all`

**Then**: 全ソースファイルをチェック

### TC-03: ディレクトリ指定

**When**: `quality-gate srcだけ` または `quality-gate src/`

**Then**: 指定ディレクトリ内のファイルのみをチェック

### TC-05: git diff が空の場合

**Given**: 変更ファイルがない

**Then**: 「変更なし」メッセージを表示して終了

### TC-06: 指定ディレクトリが存在しない場合

**When**: 存在しないディレクトリを指定

**Then**: エラーメッセージを表示

### 引数解釈ロジック

```
1. 引数が空 → デフォルト（git diff HEAD）
2. 引数に「全部」「--all」「全体」を含む → 全ファイル
3. 引数がディレクトリパス → 特定ディレクトリ
4. それ以外 → デフォルト（git diff HEAD）
```

### エラーハンドリング

#### 変更ファイルなし
```
変更ファイルがありません。チェック対象がないため終了します。
```

#### ディレクトリ不存在
```
エラー: ディレクトリ '<dir>' が存在しません。
```

---

## エージェント詳細

### correctness-reviewer

正確性を検証:
- 論理エラー（条件分岐、ループ、計算式）
- エッジケース（null/空値、境界値、不正入力）
- 例外処理（try-catch、リソース解放）

### performance-reviewer

パフォーマンスを検証:
- アルゴリズム効率（O記法、不要ループ）
- N+1問題（DBクエリ、API呼び出し）
- メモリ使用（大量データ、メモリリーク）

### security-reviewer

セキュリティを検証:
- 入力検証（サニタイズ、型チェック）
- 認証・認可（アクセス制御、セッション）
- SQLi/XSS（インジェクション対策）
- 機密データ（パスワード、APIキー）

### guidelines-reviewer

ガイドライン準拠を検証:
- コーディング規約（PSR-12、PEP8等）
- 命名規則（変数名、関数名の一貫性）
- ドキュメント（コメント、docstring）

## 信頼スコア詳細

各エージェントが0-100の信頼スコアを返す:

| スコア | 判定 | アクション |
|--------|------|-----------|
| 80-100 | BLOCK | GREENに戻って修正必須 |
| 50-79 | WARN | 警告確認後、COMMITへ |
| 0-49 | PASS | COMMITへ自動進行 |

## 出力形式

各エージェントの出力:

```json
{
  "confidence": 85,
  "issues": [
    {
      "severity": "critical",
      "message": "SQLインジェクションの脆弱性",
      "file": "src/UserController.php",
      "line": 42,
      "suggestion": "プレースホルダを使用してください"
    }
  ]
}
```

## 結果統合

最大スコアで判定:

```
================================================================================
quality-gate 完了
================================================================================
スコア: 85 (BLOCK)

correctness-reviewer: 30 (PASS)
performance-reviewer: 40 (PASS)
security-reviewer: 85 (BLOCK)
  - SQLインジェクションの脆弱性 (src/UserController.php:42)
guidelines-reviewer: 25 (PASS)

重大な問題が検出されました。GREENに戻って修正してください。
================================================================================
```
