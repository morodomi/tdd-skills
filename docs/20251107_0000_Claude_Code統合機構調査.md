# Claude Code統合機構調査 - TDDワークフロー強制のための実装戦略

**作成日時**: 2025-11-07 00:00
**目的**: Claude CodeのSkills, Commands, MCP, Subagents, Hooksの各機構を調査し、ClaudeSkillsプロジェクトのTDDワークフロー強制にどう活用できるかを研究する

---

## 目次

1. [調査背景](#調査背景)
2. [Skills（スキル）](#skillsスキル)
3. [Slash Commands（スラッシュコマンド）](#slash-commandsスラッシュコマンド)
4. [MCP（Model Context Protocol）](#mcpmodel-context-protocol)
5. [Subagents（サブエージェント）](#subagentsサブエージェント)
6. [Hooks（フック）](#hooksフック)
7. [統合戦略：TDDワークフロー強制](#統合戦略tddワークフロー強制)
8. [ClaudeSkillsプロジェクトへの適用](#claudeskillsプロジェクトへの適用)
9. [推奨実装ロードマップ](#推奨実装ロードマップ)

---

## 調査背景

### 問題点

現在のCLAUDE.mdベースのアプローチでは、以下の課題がある：

1. **強制力の欠如**: CLAUDE.mdに記述したルールは「お願い」であり、AIが無視する可能性がある
2. **エラー時のスキップ**: エラー調査時に「良かれと思って」直接コード修正してしまう
3. **フェーズ管理の曖昧さ**: PLAN/RED/GREEN/REFACTORの各フェーズが明確に強制されない
4. **スクリプト配置の誤解**: `.claude/commands/`がシェルスクリプト用と誤解していた

### 調査の目的

Claude Codeのネイティブ機構（Skills, Commands, MCP, Subagents, Hooks）を活用して、**技術的に強制可能なTDDワークフロー**を実現する方法を明らかにする。

---

## Skills（スキル）

### 概要

**Skillsとは**: モジュール化された機能で、Claudeが自動的に発見・起動する（model-invoked）

**配置場所**:
- **プロジェクトSkills**: `.claude/skills/skill-name/` - チーム共有、git管理
- **個人Skills**: `~/.claude/skills/skill-name/` - 個人用、全プロジェクトで利用可能

### 構造

必須ファイル: `SKILL.md`

```yaml
---
name: skill-identifier
description: Brief description of what this Skill does and when to use it
allowed-tools: Read, Grep, Glob  # オプション：利用可能なツールを制限
---

# Skill Name

## Instructions
Step-by-step guidance for Claude.

## Examples
Concrete examples.
```

### allowed-tools による制約

**重要**: `allowed-tools`を指定すると、Skill起動中にClaudeが使用できるツールを制限できる

例：読み取り専用Skill
```yaml
---
name: plan-mode
description: Analyze code and create plan. Use during planning phase before implementation.
allowed-tools: Read, Grep, Glob
---

# Plan Mode Skill

You are in PLAN mode. You can only read code, not modify it.

## Instructions

1. Read relevant files using Read tool
2. Search for patterns using Grep
3. Create a plan document in docs/
4. DO NOT use Edit or Write tools for code files
```

### 発見と起動

- **自動発見**: Claude Codeは起動時に`.claude/skills/`と`~/.claude/skills/`をスキャン
- **自動起動**: descriptionにマッチするリクエストが来たら自動的に起動
- **明示的起動なし**: ユーザーが`/skill-name`のように呼び出すことはできない（Slash Commandsとの違い）

### TDDワークフローへの適用

#### フェーズごとのSkill作成例

**PLAN Phase Skill** (`.claude/skills/tdd-plan/SKILL.md`):
```yaml
---
name: tdd-plan
description: Create implementation plan with test list. Use when starting new feature or bug fix before writing any code.
allowed-tools: Read, Grep, Glob, Write
---

# TDD Plan Phase

You are in the PLAN phase of TDD workflow.

## Allowed Actions

✅ Read existing code (Read, Grep, Glob)
✅ Create plan document in docs/YYYYMMDD_hhmm_機能名.md
✅ Create test list (TODO/WIP/DISCOVERED/DONE sections)

❌ Edit or create production code
❌ Write test code
❌ Run tests

## Instructions

1. Read relevant existing code
2. Create plan document: `docs/YYYYMMDD_hhmm_機能名.md`
3. Write test list with Given/When/Then structure
4. Ask user: "Plan created. Proceed to RED phase?"
```

**RED Phase Skill** (`.claude/skills/tdd-red/SKILL.md`):
```yaml
---
name: tdd-red
description: Write failing tests only. Use after plan approval, before implementation.
allowed-tools: Read, Grep, Glob, Write, Edit, Bash
---

# TDD Red Phase

You are in the RED phase of TDD workflow.

## Allowed Actions

✅ Read existing code and tests
✅ Write or edit TEST files only (tests/, *_test.php, *Test.php, test_*.py, etc.)
✅ Run tests using Bash (php artisan test, pytest, etc.)

❌ Edit or create production code (app/, src/, lib/, etc.)
❌ Fix failing tests by modifying production code

## Instructions

1. Write failing test based on test list
2. Run test suite to confirm RED state
3. If test accidentally passes, revise test to ensure proper failure
4. Ask user: "Tests are RED. Proceed to GREEN phase?"
```

**GREEN Phase Skill** (`.claude/skills/tdd-green/SKILL.md`):
```yaml
---
name: tdd-green
description: Implement minimum code to pass tests. Use after tests are failing (RED phase).
allowed-tools: Read, Grep, Glob, Write, Edit, Bash
---

# TDD Green Phase

You are in the GREEN phase of TDD workflow.

## Allowed Actions

✅ Read existing code and tests
✅ Edit or create production code (app/, src/, lib/, etc.)
✅ Run tests using Bash
✅ Add new tests to DISCOVERED section if issues found

❌ Modify test files (except for discovered edge cases)
❌ Skip running tests before completion
❌ Write more code than necessary to pass tests

## Instructions

1. Implement minimum code to pass failing tests
2. Run full test suite
3. If new edge cases discovered, add to DISCOVERED section in plan doc
4. Ensure all tests pass (100% GREEN)
5. Ask user: "All tests pass. Proceed to REFACTOR phase?"
```

### 制約事項

- **allowed-toolsのみでは不完全**: ツール制限はできるが、「テストファイルのみ編集可能」といった細かい制御はできない
- **descriptionによる起動**: 明確なdescriptionを書かないと、適切に起動されない可能性がある
- **Skill間の遷移**: Skill自体にはフェーズ遷移の機構がない（Slash CommandsやHooksで補完が必要）

---

## Slash Commands（スラッシュコマンド）

### 概要

**Slash Commandsとは**: ユーザーが明示的に呼び出すMarkdownファイル形式のプロンプトスニペット

**配置場所**:
- **プロジェクトコマンド**: `.claude/commands/command-name.md` - チーム共有
- **個人コマンド**: `~/.claude/commands/command-name.md` - 個人用

**重要な誤解の訂正**: `.claude/commands/`は**シェルスクリプトを置く場所ではなく**、Markdownファイルを置く場所

### 構造

```markdown
---
description: Brief description shown in /help
allowed-tools: Bash(git status:*), Write  # オプション：ツール制限
argument-hint: [pr-number]  # オプション：引数のヒント
---

Your instruction text here.
Use $ARGUMENTS for all arguments, or $1, $2 for positional args.
```

### SkillsとCommandsの違い

| 観点 | Skills | Slash Commands |
|------|--------|----------------|
| **起動方法** | 自動（model-invoked） | 明示的（`/command-name`） |
| **構造** | ディレクトリ + SKILL.md + 追加ファイル | 単一Markdownファイル |
| **用途** | 複雑なワークフロー、自動発見 | 頻繁に使うプロンプト、フェーズ切り替え |
| **制約** | allowed-toolsで制限可能 | allowed-toolsで制限可能 |
| **引数** | 不可 | `$ARGUMENTS`, `$1`, `$2`で対応可能 |

### TDDワークフローへの適用

#### フェーズ遷移コマンド

**INIT コマンド** (`.claude/commands/init.md`):
```markdown
---
description: Initialize new TDD cycle with plan document
allowed-tools: Write, Read, Grep, Glob
---

Start a new TDD cycle:

1. Ask user for feature/bug description
2. Create plan document: docs/YYYYMMDD_hhmm_機能名.md
3. Include test list (TODO/WIP/DISCOVERED/DONE sections)
4. Activate tdd-plan Skill for detailed planning

Do NOT write any production code or tests yet.
```

**RED コマンド** (`.claude/commands/red.md`):
```markdown
---
description: Enter RED phase - write failing tests
allowed-tools: Write, Edit, Read, Grep, Glob, Bash
---

Entering RED phase:

1. Read current plan document from docs/
2. Write failing test for next TODO item
3. Run test suite to confirm RED state
4. Update test list (move item to WIP)

Do NOT implement production code. Tests must FAIL.
```

**GREEN コマンド** (`.claude/commands/green.md`):
```markdown
---
description: Enter GREEN phase - implement minimum code
allowed-tools: Write, Edit, Read, Grep, Glob, Bash
---

Entering GREEN phase:

1. Implement minimum code to pass current failing tests
2. Run full test suite
3. Add discovered edge cases to DISCOVERED section
4. Ensure 100% test pass rate

Do NOT refactor or optimize. Just make tests pass.
```

**REFACTOR コマンド** (`.claude/commands/refactor.md`):
```markdown
---
description: Enter REFACTOR phase - improve code while maintaining tests
allowed-tools: Write, Edit, Read, Grep, Glob, Bash
---

Entering REFACTOR phase:

1. Run tests to ensure GREEN state
2. Refactor code for better design, readability, performance
3. Run tests after each refactor step
4. Update test list (move completed items to DONE)

All tests must remain GREEN throughout refactoring.
```

**REVIEW コマンド** (`.claude/commands/review.md`):
```markdown
---
description: Enter REVIEW phase - quality checks
allowed-tools: Read, Grep, Glob, Bash
---

Entering REVIEW phase:

1. Run static analysis (PHPStan level 8, mypy, etc.)
2. Check test coverage (minimum 80%, target 90%+)
3. Run code formatter (Laravel Pint, black, ruff)
4. Review code quality and documentation

Report any issues found. Do NOT fix them - add to DISCOVERED section for next cycle.
```

**COMMIT コマンド** (`.claude/commands/commit.md`):
```markdown
---
description: Create git commit for completed TDD cycle
allowed-tools: Bash(git add:*), Bash(git status:*), Bash(git diff:*), Bash(git commit:*)
---

Creating commit:

1. Run: !`git status`
2. Run: !`git diff --cached`
3. Review test list DONE section
4. Create commit message (feat/fix/refactor/test/docs/chore)
5. Execute: !`git commit -m "message"`

Include test coverage and quality checks in commit message.
```

### Bash実行とファイル参照

- **Bash実行**: `!`プレフィックスで実行（allowed-toolsで許可が必要）
  ```markdown
  Current status: !`git status`
  Test results: !`php artisan test`
  ```

- **ファイル参照**: `@`プレフィックスで内容を含める
  ```markdown
  Review @tests/Feature/UserTest.php for coverage.
  ```

### 制約事項

- **allowed-toolsの細かい制御は困難**: 「テストファイルのみ編集」のような制御はできない
- **Skillsとの組み合わせ**: Commandで起動してSkillで制約をかける組み合わせが必要
- **SlashCommand toolによる実行**: Claudeが自動的にコマンドを実行できるが、built-inコマンドは不可

---

## MCP（Model Context Protocol）

### 概要

**MCPとは**: AI-外部ツール統合のためのオープンソース標準プロトコル

**提供する機能**:
- **Tools**: 実行可能な関数（例: GitHub API操作、DB クエリ）
- **Resources**: `@servername:protocol://path`形式で参照可能なデータ
- **Prompts**: `/mcp__servername__promptname`形式のスラッシュコマンド

### 設定方法

#### HTTP Server（クラウドサービス向け）
```bash
claude mcp add --transport http github https://api.githubcopilot.com/mcp/
```

#### Stdio Server（ローカルツール）
```bash
claude mcp add --transport stdio phpstan \
  --env PROJECT_PATH=$(pwd) \
  -- npx -y @someorg/phpstan-mcp-server
```

#### 設定スコープ

| スコープ | 保存場所 | 優先度 | 用途 |
|---------|---------|-------|------|
| **Local** | User settings（現プロジェクトのみ） | 最高 | 個人用、実験的、機密情報 |
| **Project** | `.mcp.json`（バージョン管理） | 中 | チーム共有ツール |
| **User** | User settings（全プロジェクト） | 最低 | クロスプロジェクトユーティリティ |

優先順位: local > project > user

### Skillsとの統合

**ドキュメントの記述**: "MCP tools appear alongside manually configured MCP tools"

**Subagentsでの利用**: `tools`フィールドを省略すると、「subagents inherit all MCP tools available to the main thread」

**Skills固有の統合詳細は未記載**: ドキュメントにはSkillsが直接MCPツールを使う方法の詳細な記述なし

### TDDワークフローへの適用

#### 仮想的なMCP Serverの例

**PHPStan MCP Server** (仮想):
```bash
claude mcp add --transport stdio phpstan \
  --env PROJECT_PATH=$(pwd) \
  -- npx -y @phpstan/mcp-server
```

用途: REVIEW フェーズで静的解析を実行

**PHPUnit Coverage MCP Server** (仮想):
```bash
claude mcp add --transport stdio phpunit-coverage \
  --env PROJECT_PATH=$(pwd) \
  -- npx -y @phpunit/coverage-mcp-server
```

用途: REVIEW フェーズでカバレッジレポート取得

**Pytest MCP Server** (仮想):
```bash
claude mcp add --transport stdio pytest \
  -- npx -y @pytest/mcp-server
```

用途: RED/GREEN フェーズでテスト実行

#### 実在するMCP Serverの活用

**GitHub MCP Server**:
```bash
claude mcp add --transport http github https://api.githubcopilot.com/mcp/
```

用途:
- COMMIT フェーズでPR作成
- DISCOVERED セクションのタスクをIssue化
- PR レビューの取得

### 制約事項

- **利用可能なMCP Serverに依存**: PHPStan/PHPUnit専用MCPサーバーが存在しない可能性がある（BashでCLI実行で代用可能）
- **Skillsとの統合が不明確**: ドキュメントにはSkills内でのMCP tool使用の詳細が記載されていない
- **セキュリティリスク**: "Use third party MCP servers at your own risk"

---

## Subagents（サブエージェント）

### 概要

**Subagentsとは**: 特定のタスクを処理する専門化されたAIアシスタント。独自のコンテキストウィンドウを持つ。

**配置場所**:
- **プロジェクトSubagents**: `.claude/agents/agent-name.md` - 最高優先度
- **個人Subagents**: `~/.claude/agents/agent-name.md` - 低優先度
- **CLI指定**: `--agents`フラグでセッション固有定義

### 構造

```markdown
---
name: subagent-identifier
description: Purpose and invocation conditions
tools: Tool1, Tool2, Tool3  # オプション：省略時はすべてのMCPツール継承
model: sonnet  # オプション：モデル指定
---

System prompt content here...
```

### Built-in Subagent

**Plan Subagent**: プランモード用の組み込みSubagent

- **目的**: コードベース調査と計画作成
- **モデル**: Sonnet
- **ツール**: Read, Glob, Grep, Bash

### 起動方法

- **自動起動**: タスク内容とSubagent descriptionに基づいてClaudeが自動委譲
- **明示的起動**: "Use the [name] subagent to [task]"

### Skillsとの違い

ドキュメントにはSkillsとの比較が記載されていないため、この調査では明確にできない。

**推測される違い**:
- **Subagents**: 独立したコンテキストで専門タスクを処理、結果を返す
- **Skills**: メインスレッドのコンテキストで動作、制約を課す

### TDDワークフローへの適用

#### Test Runner Subagent

ドキュメントの例:
```markdown
---
name: test-runner
description: Run tests and fix failures. Use when code changes are made.
tools: Bash, Read, Edit, Write
---

When you see code changes, proactively run the appropriate tests.
If tests fail, analyze the failures and fix them while preserving the original test intent.
```

**TDD適用の課題**: この例は「テスト失敗時に自動修正」するが、TDDでは「テスト失敗→手動でGREEN phase」という流れが望ましい

#### TDD専用Subagent例

**RED Phase Test Writer** (`.claude/agents/red-phase-tdd.md`):
```markdown
---
name: red-phase-tdd
description: Write failing tests based on test list. Use when user requests RED phase or test creation.
tools: Read, Grep, Glob, Write, Edit, Bash
model: sonnet
---

You are a TDD RED phase specialist.

## Your Task

1. Read the plan document from docs/YYYYMMDD_hhmm_*.md
2. Identify the next TODO item in the test list
3. Write a failing test for that item
4. Run the test suite to confirm RED state
5. Report back: "Test written and confirmed RED. Ready for GREEN phase."

## Constraints

- Write ONLY test code
- Do NOT implement production code
- Do NOT fix failing tests by changing production code
- Ensure tests FAIL for the right reason
```

**GREEN Phase Implementer** (`.claude/agents/green-phase-tdd.md`):
```markdown
---
name: green-phase-tdd
description: Implement minimum code to pass failing tests. Use when tests are RED and user requests GREEN phase.
tools: Read, Grep, Glob, Write, Edit, Bash
model: sonnet
---

You are a TDD GREEN phase specialist.

## Your Task

1. Read failing test output
2. Implement MINIMUM code to make tests pass
3. Run full test suite after each change
4. If new edge cases discovered, note them for DISCOVERED section
5. Report back: "All tests GREEN. Ready for REFACTOR phase."

## Constraints

- Write ONLY production code
- Do NOT modify test files
- Do NOT over-engineer or optimize (just make it work)
- Run tests frequently
```

### 制約事項

- **フェーズ遷移の制御なし**: Subagent自体はフェーズ管理機能を持たない
- **allowed-toolsよりツール指定**: `tools`フィールドで指定するが、allowed-toolsと同様の制約
- **独立コンテキスト**: メインスレッドとの情報共有が限定的

---

## Hooks（フック）

### 概要

**Hooksとは**: Claude Codeのライフサイクル各時点で実行されるユーザー定義シェルコマンド

**重要性**: 「LLMに選択させるのではなく、確実に実行されるアプリケーションレベルのルール」を実現

**配置場所**:
- **ユーザー設定**: `~/.claude/settings.json` - 全プロジェクトに影響
- **プロジェクト設定**: `.claude/hooks/` - プロジェクト固有ルール

### Hook Events

| Event | 実行タイミング | ブロック可能 |
|-------|--------------|-------------|
| **PreToolUse** | ツール呼び出し前 | ✅ Yes (exit code 2) |
| **PostToolUse** | ツール呼び出し後 | ❌ No |
| **UserPromptSubmit** | ユーザープロンプト送信時、Claudeが処理する前 | ❌ No |
| **Notification** | Claude Code通知送信時 | ❌ No |
| **Stop** | Claudeレスポンス終了時 | ❌ No |
| **SubagentStop** | Subagentタスク完了時 | ❌ No |
| **PreCompact** | コンパクト操作前 | ❌ No |
| **SessionStart** | セッション開始/再開時 | ❌ No |
| **SessionEnd** | セッション終了時 | ❌ No |

### 構造

```json
{
  "hooks": {
    "EventType": [
      {
        "matcher": "ToolName|OtherTool|*",
        "hooks": [
          {
            "type": "command",
            "command": "shell-command-here"
          }
        ]
      }
    ]
  }
}
```

**データ受信**: Hookコマンドは標準入力経由でJSONデータを受け取る

**ブロック**: PreToolUse hookがexit code 2を返すと、ツール実行がブロックされる

### TDDワークフローへの適用

#### 1. ファイル保護 - 本番ファイルの編集防止

```json
{
  "hooks": {
    "PreToolUse": [
      {
        "matcher": "Edit|Write",
        "hooks": [
          {
            "type": "command",
            "command": "python3 -c \"import json, sys; data=json.load(sys.stdin); path=data.get('tool_input',{}).get('file_path',''); sys.exit(2 if any(p in path for p in ['.env', 'package-lock.json', '.git/']) else 0)\""
          }
        ]
      }
    ]
  }
}
```

#### 2. テストなし実装の防止（RED phase必須）

**コンセプト**: 本番コードを編集する前に、必ずテストファイルが存在することを確認

```json
{
  "hooks": {
    "PreToolUse": [
      {
        "matcher": "Edit|Write",
        "hooks": [
          {
            "type": "command",
            "command": "bash -c 'data=$(cat); path=$(echo \"$data\" | jq -r \".tool_input.file_path // empty\"); if [[ \"$path\" =~ ^(app/|src/|lib/) ]] && [[ ! \"$path\" =~ (Test\\.php|_test\\.py|test_.*\\.py)$ ]]; then test_file=$(echo \"$path\" | sed \"s/\\.php$/Test.php/; s/\\.py$/_test.py/\"); if [[ ! -f \"tests/$test_file\" ]] && [[ ! -f \"$test_file\" ]]; then echo \"ERROR: No test file found for $path. Write tests first (RED phase).\" >&2; exit 2; fi; fi'"
          }
        ]
      }
    ]
  }
}
```

**動作**:
1. Edit/Write操作を検出
2. ファイルパスが本番コード（app/, src/, lib/）か確認
3. 対応するテストファイルの存在をチェック
4. テストファイルがなければexit code 2でブロック

#### 3. テスト実行の自動化（POST hook）

```json
{
  "hooks": {
    "PostToolUse": [
      {
        "matcher": "Edit|Write",
        "hooks": [
          {
            "type": "command",
            "command": "bash -c 'data=$(cat); path=$(echo \"$data\" | jq -r \".tool_input.file_path // empty\"); if [[ \"$path\" =~ \\.(php|py)$ ]] && [[ ! \"$path\" =~ ^docs/ ]]; then if [[ -f \"artisan\" ]]; then php artisan test --stop-on-failure; elif [[ -f \"pytest.ini\" ]] || [[ -f \"pyproject.toml\" ]]; then pytest --maxfail=1; fi; fi'"
          }
        ]
      }
    ]
  }
}
```

**動作**:
1. Edit/Write完了後に実行
2. PHPファイルまたはPythonファイルの変更を検出
3. Laravel環境なら`php artisan test`、Python環境なら`pytest`を自動実行
4. テスト失敗時は出力を表示（exit code 2ではないのでブロックはしない）

#### 4. PLAN phase中の実装コード編集防止

**課題**: 現在のフェーズ状態をHookが認識する方法が必要

**解決案1: 環境変数**
```bash
export TDD_PHASE=PLAN
```

```json
{
  "hooks": {
    "PreToolUse": [
      {
        "matcher": "Edit|Write",
        "hooks": [
          {
            "type": "command",
            "command": "bash -c 'data=$(cat); path=$(echo \"$data\" | jq -r \".tool_input.file_path // empty\"); if [[ \"$TDD_PHASE\" == \"PLAN\" ]] && [[ \"$path\" =~ ^(app/|src/|lib/|tests/) ]]; then echo \"ERROR: Cannot edit code in PLAN phase. Use /red to start RED phase.\" >&2; exit 2; fi'"
          }
        ]
      }
    ]
  }
}
```

**解決案2: フェーズファイル**

Slash Commandでフェーズを記録:
```markdown
---
description: Enter PLAN phase
---

!`echo "PLAN" > .claude/current-phase`

Starting PLAN phase...
```

Hook側でフェーズファイルを読み取り:
```json
{
  "hooks": {
    "PreToolUse": [
      {
        "matcher": "Edit|Write",
        "hooks": [
          {
            "type": "command",
            "command": "bash -c 'phase=$(cat .claude/current-phase 2>/dev/null || echo \"NONE\"); data=$(cat); path=$(echo \"$data\" | jq -r \".tool_input.file_path // empty\"); if [[ \"$phase\" == \"PLAN\" ]] && [[ \"$path\" =~ ^(app/|src/|lib/|tests/) ]]; then echo \"ERROR: Cannot edit code in PLAN phase.\" >&2; exit 2; fi'"
          }
        ]
      }
    ]
  }
}
```

#### 5. RED phase中の本番コード編集防止

```json
{
  "hooks": {
    "PreToolUse": [
      {
        "matcher": "Edit|Write",
        "hooks": [
          {
            "type": "command",
            "command": "bash -c 'phase=$(cat .claude/current-phase 2>/dev/null || echo \"NONE\"); data=$(cat); path=$(echo \"$data\" | jq -r \".tool_input.file_path // empty\"); if [[ \"$phase\" == \"RED\" ]] && [[ \"$path\" =~ ^(app/|src/|lib/) ]] && [[ ! \"$path\" =~ (Test\\.php|_test\\.py|test_.*\\.py)$ ]]; then echo \"ERROR: Cannot edit production code in RED phase. Only test files allowed.\" >&2; exit 2; fi'"
          }
        ]
      }
    ]
  }
}
```

#### 6. GREEN phase中のテストファイル編集防止

```json
{
  "hooks": {
    "PreToolUse": [
      {
        "matcher": "Edit|Write",
        "hooks": [
          {
            "type": "command",
            "command": "bash -c 'phase=$(cat .claude/current-phase 2>/dev/null || echo \"NONE\"); data=$(cat); path=$(echo \"$data\" | jq -r \".tool_input.file_path // empty\"); if [[ \"$phase\" == \"GREEN\" ]] && [[ \"$path\" =~ (Test\\.php|_test\\.py|test_.*\\.py)$ ]]; then echo \"WARNING: Editing test files in GREEN phase. Add discovered cases to DISCOVERED section instead.\" >&2; fi'"
          }
        ]
      }
    ]
  }
}
```

（exit 2ではなくwarningのみ - 発見されたエッジケースのテスト追加は許容）

### セキュリティ注意事項

**重要**: "Hooks run automatically during the agent loop with your current environment's credentials"

悪意のあるHookは以下が可能:
- データ漏洩
- 認証情報の窃取
- 任意のコマンド実行

**対策**: 必ず実装内容をレビューしてから登録

---

## 統合戦略：TDDワークフロー強制

### 各機構の役割分担

| 機構 | 役割 | TDDワークフローでの用途 |
|------|------|----------------------|
| **CLAUDE.md** | プロジェクト説明、ガイドライン | TDDの思想、テストリスト管理方法の説明 |
| **Skills** | 自動発見型の制約とガイダンス | フェーズごとの推奨アクション、allowed-tools制限 |
| **Slash Commands** | ユーザー起動型のフェーズ遷移 | `/init`, `/red`, `/green`, `/refactor`, `/review`, `/commit` |
| **Hooks** | 強制的なルール実行とブロック | コード編集の防止、自動テスト実行、フェーズ違反検出 |
| **Subagents** | 専門タスクの委譲 | テスト作成、実装、静的解析の独立実行 |
| **MCP** | 外部ツール統合 | GitHub連携、カバレッジレポート、静的解析ツール |

### 統合アーキテクチャ

```
┌─────────────────────────────────────────────────────────────┐
│                         User Request                          │
└───────────────────────────┬───────────────────────────────────┘
                            │
                ┌───────────┴───────────┐
                │                       │
        ┌───────▼────────┐     ┌────────▼────────┐
        │ Slash Commands  │     │ Natural Request │
        │ (/red, /green)  │     │ (auto-discover) │
        └───────┬────────┘     └────────┬────────┘
                │                       │
                └───────────┬───────────┘
                            │
                    ┌───────▼────────┐
                    │  Skills Layer  │
                    │  (tdd-plan,    │
                    │   tdd-red,     │
                    │   tdd-green)   │
                    └───────┬────────┘
                            │
                ┌───────────▼────────────┐
                │   Hooks Layer (PRE)    │
                │  - Phase validation    │
                │  - File type check     │
                │  - Test existence check│
                └───────────┬────────────┘
                            │
                    ┌───────▼────────┐
                    │  Tool Execution│
                    │  (Edit, Write, │
                    │   Bash, etc.)  │
                    └───────┬────────┘
                            │
                ┌───────────▼────────────┐
                │   Hooks Layer (POST)   │
                │  - Auto test execution │
                │  - Coverage check      │
                │  - Static analysis     │
                └───────────┬────────────┘
                            │
                    ┌───────▼────────┐
                    │  Subagents     │
                    │  (Optional     │
                    │   delegation)  │
                    └───────┬────────┘
                            │
                    ┌───────▼────────┐
                    │   MCP Tools    │
                    │  (GitHub, DB,  │
                    │   External)    │
                    └────────────────┘
```

### レイヤー間の相互作用

#### 1. PLAN Phase の流れ

```
User: "/init" または "新機能XXXを実装したい"
  ↓
Slash Command (/init) または Skills (tdd-plan) 起動
  ↓
allowed-tools: Read, Grep, Glob, Write（docsのみ）
  ↓
Hook (PreToolUse): Edit/Writeがapp/src/lib/を対象なら BLOCK
  ↓
Plan document作成: docs/YYYYMMDD_hhmm_機能名.md
  ↓
!`echo "PLAN" > .claude/current-phase`（フェーズ記録）
  ↓
User確認: "Plan created. Proceed to RED phase? (type /red)"
```

#### 2. RED Phase の流れ

```
User: "/red"
  ↓
Slash Command (/red) 実行
  ↓
!`echo "RED" > .claude/current-phase`
  ↓
Skills (tdd-red) 起動 または Subagent (red-phase-tdd) 委譲
  ↓
allowed-tools: Read, Grep, Glob, Write, Edit（testsのみ）, Bash
  ↓
Hook (PreToolUse): Edit/Writeがapp/src/lib/対象なら BLOCK
  ↓
Test作成: tests/Feature/XXXTest.php
  ↓
Hook (PostToolUse): 自動で `php artisan test` 実行
  ↓
RED状態確認（テスト失敗を確認）
  ↓
User確認: "Tests are RED. Proceed to GREEN phase? (type /green)"
```

#### 3. GREEN Phase の流れ

```
User: "/green"
  ↓
Slash Command (/green) 実行
  ↓
!`echo "GREEN" > .claude/current-phase`
  ↓
Skills (tdd-green) 起動 または Subagent (green-phase-tdd) 委譲
  ↓
allowed-tools: Read, Grep, Glob, Write, Edit（app/src/lib/）, Bash
  ↓
Hook (PreToolUse): Edit/Writeがtestsディレクトリなら WARNING
  ↓
Production code実装: app/Services/XXXService.php
  ↓
Hook (PostToolUse): 自動で `php artisan test` 実行
  ↓
GREEN状態確認（全テスト成功を確認）
  ↓
発見されたエッジケース → DISCOVERED section追加
  ↓
User確認: "All tests GREEN. Proceed to REFACTOR? (type /refactor)"
```

#### 4. REFACTOR Phase の流れ

```
User: "/refactor"
  ↓
Slash Command (/refactor) 実行
  ↓
!`echo "REFACTOR" > .claude/current-phase`
  ↓
Skills (tdd-refactor) 起動
  ↓
allowed-tools: Read, Grep, Glob, Write, Edit, Bash
  ↓
Hook (PreToolUse): なし（全ファイル編集可能、但しテスト維持が前提）
  ↓
Refactoring実行
  ↓
Hook (PostToolUse): 毎回 `php artisan test` 実行
  ↓
GREEN維持確認
  ↓
User確認: "Refactoring complete. Proceed to REVIEW? (type /review)"
```

#### 5. REVIEW Phase の流れ

```
User: "/review"
  ↓
Slash Command (/review) 実行
  ↓
!`echo "REVIEW" > .claude/current-phase`
  ↓
Skills (tdd-review) 起動 または Subagent (code-reviewer) 委譲
  ↓
allowed-tools: Read, Grep, Glob, Bash（編集不可）
  ↓
静的解析: !`vendor/bin/phpstan analyse --level 8`
  ↓
カバレッジ: !`php artisan test --coverage --min=80`
  ↓
コードフォーマット: !`vendor/bin/pint --test`
  ↓
MCP (Optional): GitHub MCP経由でPR作成準備
  ↓
問題発見 → DISCOVERED section追加（次サイクルで修正）
  ↓
User確認: "Review complete. Ready to commit? (type /commit)"
```

#### 6. COMMIT Phase の流れ

```
User: "/commit"
  ↓
Slash Command (/commit) 実行
  ↓
allowed-tools: Bash(git:*)
  ↓
!`git status`
!`git diff --staged`
  ↓
Test list DONE section確認
  ↓
Commit message作成（feat/fix/refactor/test/docs/chore）
  ↓
!`git add .`
!`git commit -m "feat: XXX機能実装"`
  ↓
Hook (PostToolUse): git log確認、タグ付け等（Optional）
  ↓
MCP (Optional): GitHub MCP経由でPR作成
  ↓
!`echo "INIT" > .claude/current-phase`（次サイクルへ）
  ↓
User確認: "Committed. Start new cycle? (type /init)"
```

---

## ClaudeSkillsプロジェクトへの適用

### 現在の状況

**完了済み**:
- ✅ CLAUDE.mdテンプレート（Generic, Laravel, Bedrock）
- ✅ TDDワークフロー説明（INIT → COMMIT）
- ✅ バグ修正のTDDフロー
- ✅ AIアシスタントへの厳格な指示
- ✅ テストリスト管理（Kent Beckアプローチ）
- ✅ install.sh（テンプレート配布用）

**未実装**:
- ❌ Skills（tdd-plan, tdd-red, tdd-green, tdd-refactor, tdd-review）
- ❌ Slash Commands（/init, /red, /green, /refactor, /review, /commit）
- ❌ Hooks（フェーズ強制、テスト自動実行）
- ❌ Subagents（Optional: red-phase-tdd, green-phase-tdd）
- ❌ MCP統合（Optional: GitHub連携）

### 推奨実装順序

#### Phase 1: Minimal Viable TDD Enforcement（最小限の強制力）

**目標**: PLAN/RED/GREEN の基本フローを強制

**実装内容**:
1. **Slash Commands 作成**
   - `.claude/commands/init.md`
   - `.claude/commands/red.md`
   - `.claude/commands/green.md`
   - `.claude/commands/refactor.md`
   - `.claude/commands/review.md`
   - `.claude/commands/commit.md`

2. **フェーズ記録機構**
   - 各Commandで `!echo "PHASE_NAME" > .claude/current-phase`

3. **Hooks 作成（最小限）**
   - PreToolUse: PLAN phase中のコード編集防止
   - PreToolUse: RED phase中の本番コード編集防止
   - PostToolUse: コード変更後の自動テスト実行

**成果物**:
```
templates/generic/.claude/
├── commands/
│   ├── init.md
│   ├── red.md
│   ├── green.md
│   ├── refactor.md
│   ├── review.md
│   └── commit.md
└── hooks/
    └── tdd-enforcement.json
```

**テスト方法**:
1. 既存Laravelプロジェクトに適用
2. `/init` → plan作成
3. `/red` → テスト作成（app/編集はブロックされることを確認）
4. `/green` → 実装（tests/編集はwarning）
5. 自動テスト実行を確認

#### Phase 2: Skills Integration（自動発見の追加）

**目標**: Slash Commandを使わなくても、自然な会話でフェーズ遷移

**実装内容**:
1. **Skills 作成**
   - `.claude/skills/tdd-plan/SKILL.md`
   - `.claude/skills/tdd-red/SKILL.md`
   - `.claude/skills/tdd-green/SKILL.md`
   - `.claude/skills/tdd-refactor/SKILL.md`
   - `.claude/skills/tdd-review/SKILL.md`

2. **allowed-tools 設定**
   - tdd-plan: Read, Grep, Glob, Write（docsのみ）
   - tdd-red: Read, Grep, Glob, Write, Edit（testsのみ）, Bash
   - tdd-green: Read, Grep, Glob, Write, Edit（app/のみ）, Bash

**成果物**:
```
templates/generic/.claude/
├── skills/
│   ├── tdd-plan/
│   │   └── SKILL.md
│   ├── tdd-red/
│   │   └── SKILL.md
│   ├── tdd-green/
│   │   └── SKILL.md
│   ├── tdd-refactor/
│   │   └── SKILL.md
│   └── tdd-review/
│       └── SKILL.md
└── (commands/, hooks/ from Phase 1)
```

**テスト方法**:
1. "新しい機能XXXを実装したい" → tdd-plan Skillが自動起動
2. "テストを書いて" → tdd-red Skillが自動起動
3. Skills のallowed-toolsが正しく機能することを確認

#### Phase 3: Advanced Hooks（高度な制約）

**目標**: より細かい制御とエラー防止

**実装内容**:
1. **Hook強化**
   - PreToolUse: テスト未存在時の本番コード編集防止
   - PreToolUse: GREEN phase中のテストファイル編集警告
   - PostToolUse: カバレッジ自動チェック（80%未満で警告）
   - PostToolUse: 静的解析自動実行（PHPStan, mypy）

2. **Hook設定の精緻化**
   - Laravel用、Python用でフック内容を分岐
   - カバレッジ閾値の設定ファイル化

**成果物**:
```
templates/laravel/.claude/hooks/
├── tdd-enforcement.json（基本制約）
├── test-coverage.json（カバレッジチェック）
└── static-analysis.json（PHPStan実行）

templates/python/.claude/hooks/
├── tdd-enforcement.json
├── test-coverage.json（pytest-cov）
└── static-analysis.json（mypy, ruff）
```

**テスト方法**:
1. テストファイル未作成で本番コード編集 → ブロック確認
2. カバレッジ不足のコミット → 警告確認
3. 静的解析エラー → 警告確認

#### Phase 4: Subagents（Optional: タスク委譲）

**目標**: 複雑なタスクを専門Subagentに委譲

**実装内容**:
1. **Subagents 作成**
   - `.claude/agents/red-phase-tdd.md`
   - `.claude/agents/green-phase-tdd.md`
   - `.claude/agents/code-reviewer.md`

2. **Slash CommandsからSubagent起動**
   - `/red` → "Use red-phase-tdd subagent to write tests"

**成果物**:
```
templates/generic/.claude/
├── agents/
│   ├── red-phase-tdd.md
│   ├── green-phase-tdd.md
│   └── code-reviewer.md
└── (skills/, commands/, hooks/ from Phase 1-3)
```

**テスト方法**:
1. Subagentの独立コンテキストで動作確認
2. メインスレッドとの情報共有確認
3. Subagent完了後のレポート確認

#### Phase 5: MCP Integration（Optional: 外部ツール統合）

**目標**: GitHub, カバレッジツール, 静的解析ツールの統合

**実装内容**:
1. **MCP設定追加**
   - `.mcp.json`（project scope）
   - GitHub MCP Server設定
   - （仮想）PHPStan MCP Server
   - （仮想）Pytest Coverage MCP Server

2. **Skills/Commands/HooksでMCPツール利用**
   - `/commit` → GitHub MCP経由でPR作成
   - `/review` → 静的解析MCPツール実行

**成果物**:
```
templates/laravel/
├── .mcp.json
└── .claude/
    └── (skills/, commands/, hooks/ from Phase 1-4)

templates/python/
├── .mcp.json
└── .claude/
    └── (skills/, commands/, hooks/ from Phase 1-4)
```

**テスト方法**:
1. GitHub MCP Server接続確認
2. PR自動作成確認
3. Issue自動作成（DISCOVERED section連携）確認

---

## 推奨実装ロードマップ

### Week 1: Phase 1 実装

**Day 1-2: Slash Commands作成**
- [ ] `.claude/commands/init.md` 作成
- [ ] `.claude/commands/red.md` 作成
- [ ] `.claude/commands/green.md` 作成
- [ ] `.claude/commands/refactor.md` 作成
- [ ] `.claude/commands/review.md` 作成
- [ ] `.claude/commands/commit.md` 作成

**Day 3-4: Hooks作成（基本）**
- [ ] `.claude/hooks/tdd-enforcement.json` 作成
  - [ ] PreToolUse: PLAN phase中のコード編集防止
  - [ ] PreToolUse: RED phase中の本番コード編集防止
  - [ ] PostToolUse: 自動テスト実行

**Day 5: テストと調整**
- [ ] 既存Laravelプロジェクトに適用
- [ ] TDDサイクル実行テスト
- [ ] Hook動作確認

**Day 6-7: ドキュメント作成**
- [ ] `docs/YYYYMMDD_hhmm_Phase1実装完了.md`
- [ ] README更新（Phase 1完了を反映）
- [ ] install.sh更新（Hooks設定含む）

### Week 2: Phase 2 実装

**Day 8-10: Skills作成**
- [ ] `.claude/skills/tdd-plan/SKILL.md`
- [ ] `.claude/skills/tdd-red/SKILL.md`
- [ ] `.claude/skills/tdd-green/SKILL.md`
- [ ] `.claude/skills/tdd-refactor/SKILL.md`
- [ ] `.claude/skills/tdd-review/SKILL.md`

**Day 11-12: Skills統合テスト**
- [ ] 自動発見動作確認
- [ ] allowed-tools制約動作確認
- [ ] Slash Commands + Skills併用テスト

**Day 13-14: ドキュメント作成とリリース**
- [ ] `docs/YYYYMMDD_hhmm_Phase2実装完了.md`
- [ ] README更新
- [ ] サンプルプロジェクト作成（examples/）

### Week 3-4: Phase 3-5（Optional）

**Phase 3: Advanced Hooks**（Week 3前半）
- [ ] テスト未存在チェックHook
- [ ] カバレッジチェックHook
- [ ] 静的解析Hook

**Phase 4: Subagents**（Week 3後半）
- [ ] red-phase-tdd Subagent
- [ ] green-phase-tdd Subagent
- [ ] code-reviewer Subagent

**Phase 5: MCP Integration**（Week 4）
- [ ] GitHub MCP設定
- [ ] 静的解析MCP統合（可能なら）
- [ ] カバレッジMCP統合（可能なら）

### リリース計画

**v0.1.0 (Phase 1完了時)**:
- Slash Commands + 基本Hooks
- Laravel/Generic/Bedrockテンプレート対応

**v0.2.0 (Phase 2完了時)**:
- Skills追加
- 自動発見機能

**v0.3.0 (Phase 3完了時)**:
- Advanced Hooks
- カバレッジ/静的解析統合

**v1.0.0 (Phase 4-5完了時)**:
- Subagents統合
- MCP統合
- 完全なTDD強制フレームワーク

---

## まとめ

### 重要な発見

1. **Hooksが最も強力な強制力を持つ**
   - PreToolUse hookでexit code 2を返せば、確実にブロック可能
   - LLMの判断に依存しない、アプリケーションレベルの制約

2. **Slash Commandsがユーザー体験を向上**
   - `/red`, `/green`のような明示的フェーズ遷移が直感的
   - Skillsの自動発見と併用することで、柔軟性と制御を両立

3. **Skillsのallowed-toolsは補完的**
   - 細かいファイルレベル制御はHooksに任せる
   - Skillsは「このフェーズで何をすべきか」のガイダンスを提供

4. **フェーズ状態管理が鍵**
   - `.claude/current-phase`ファイルでフェーズを記録
   - Hooks/Skills/Commandsすべてでこの状態を参照

5. **Subagents/MCPはOptional**
   - Phase 1-2だけでも十分強力なTDD強制が可能
   - Phase 3以降は高度な統合やチーム展開時に追加

### 次のアクション

1. **Phase 1実装開始**: Slash Commands + 基本Hooks作成
2. **既存プロジェクトでテスト**: 実際のワークフローで検証
3. **フィードバック収集**: 不便な点、改善点の洗い出し
4. **Phase 2以降の計画調整**: 実装経験を元に優先順位再評価

---

**作成者**: Claude Code
**レビュー**: 未実施
**次回更新**: Phase 1実装完了時
