# Claude Skills & MCP 調査結果

**作成日**: 2025-10-22
**目的**: TDD開発環境構築のための技術調査

---

## 1. Claude Skillsとは

### 概要
**Claude Skills**は、Claude用の専門知識・ワークフローを提供するモジュラーパッケージです。

```
Skill = フォルダ + SKILL.md + 追加リソース（オプション）
```

### 特徴

#### ✅ Progressive Disclosure（段階的な情報開示）
- **メタデータ**: 常に読み込まれる（30トークン程度）
- **SKILL.md**: 関連性がある時のみ読み込まれる
- **リソース**: 必要に応じて読み込まれる

これにより、MCPのように「すべての機能を前もって説明（数千トークン）」する必要がなく、効率的です。

#### ✅ 4つの原則
1. **Composable（組み合わせ可能）**: 複数のSkillsが自動的に協調動作
2. **Portable（移植可能）**: Claude.ai、Claude Code、API すべてで同じ形式
3. **Efficient（効率的）**: 必要な要素だけ読み込む
4. **Powerful（強力）**: 実行可能なスクリプトを含められる

### 基本構造

```
my-skill/
├── SKILL.md           # 必須: YAMLメタデータ + Markdown説明
├── scripts/           # オプション: 実行可能スクリプト
├── references/        # オプション: 必要時に読み込まれるドキュメント
└── assets/            # オプション: テンプレート、画像など
```

### SKILL.mdの形式

```markdown
---
name: skill-name
description: このスキルが何をするか、いつ使うべきかの完全な説明
allowed-tools: Read, Grep, Glob  # オプション: ツール制限
---

# スキルの詳細説明

ここにClaude向けの詳細な指示を記述。

## 使い方

...
```

**重要**: `description` フィールドはClaude が自動的にスキルを発見するために使用されます。
- 機能だけでなく「いつ使うべきか」も記述する
- ユーザーが言及しそうなキーワードを含める

---

## 2. MCPとの違い

| 観点 | MCP (Model Context Protocol) | Claude Skills |
|------|------------------------------|---------------|
| **目的** | 外部ツール・データソースへの接続 | 手順的知識・ワークフロー提供 |
| **機能** | APIアクセス、データベース接続、ツール実行 | 「どうやるか」を教える |
| **実装** | プロトコルベースの接続 | Markdownファイル + スクリプト |
| **トークン効率** | 前もってすべての機能を説明（数千トークン） | 30トークンの説明 + 必要時のみ詳細読み込み |
| **例** | PHPStan統合、PHPUnit統合 | TDDワークフロー、コーディング規約 |

### 補完関係

**MCPとSkillsは一緒に使うことで真価を発揮します**:

```
MCP: PHPStanへの接続を提供
   ↓
Skill: PHPStanをいつ、どう使うかを教える
```

具体例:
```markdown
---
name: phpstan-quality-check
description: PHPStan Level 9で品質チェックを実行する際に使用
---

# PHPStan品質チェック

## いつ使うか
- REFACTORフェーズの後
- コミット前
- Pull Request作成前

## 手順
1. PHPStan MCP経由で解析実行
2. Level 9でエラーゼロを確認
3. エラーがあれば修正方法を提案
```

---

## 3. 既存プロジェクトへの導入方法

### 3.1 ディレクトリ構造

Claude Codeは以下の階層で設定を管理します:

```
# グローバル設定（個人用）
~/.claude/
├── CLAUDE.md          # すべてのプロジェクトに適用
└── skills/            # 個人用Skills

# プロジェクト設定（チーム共有）
your-project/
├── .claude/
│   ├── skills/        # プロジェクト固有Skills（gitコミット）
│   └── commands/      # スラッシュコマンド（gitコミット）
├── CLAUDE.md          # プロジェクト設定（gitコミット）
└── CLAUDE.local.md    # 個人用上書き（gitignore）
```

**優先順位**: `CLAUDE.local.md` > `CLAUDE.md` > `~/.claude/CLAUDE.md`

### 3.2 Skills配置の選択肢

#### A. プロジェクト固有（推奨）

```bash
your-project/
└── .claude/
    └── skills/
        ├── tdd-plan/
        │   └── SKILL.md
        ├── tdd-red/
        │   └── SKILL.md
        └── tdd-green/
            └── SKILL.md
```

**メリット**:
- ✅ gitで管理できる
- ✅ チームメンバーと共有できる
- ✅ プロジェクト固有のルールを適用できる

**デメリット**:
- ❌ プロジェクトごとに配置が必要

#### B. 個人用グローバル

```bash
~/.claude/
└── skills/
    └── tdd-workflow/
        └── SKILL.md
```

**メリット**:
- ✅ すべてのプロジェクトで使える
- ✅ 1回の設定で完了

**デメリット**:
- ❌ チーム共有できない
- ❌ プロジェクト固有のカスタマイズが難しい

#### C. Plugin経由

```bash
# Marketplaceからインストール
/plugin marketplace add anthropics/skills
/plugin install tdd-workflow@your-marketplace
```

**メリット**:
- ✅ バージョン管理が容易
- ✅ 更新が簡単

**デメリット**:
- ❌ 自分でMarketplaceを用意する必要がある

### 3.3 推奨アプローチ

**ユースケース別の推奨**:

| ユースケース | 推奨方法 | 理由 |
|-------------|---------|------|
| 個人開発・複数プロジェクト | プロジェクト固有 | プロジェクトごとに仕様が異なる（Laravel/Django/WordPress） |
| チーム開発 | プロジェクト固有 | チームメンバーと共有できる |
| 汎用的な個人用ツール | グローバル | すべてのプロジェクトで使える |

**あなたのケース（個人開発・複数プロジェクト）**:

```
プロジェクト固有 + テンプレートリポジトリ
```

理由:
1. Laravel/Django/Flask/WordPressで設定が異なる
2. 既存プロジェクト/新規プロジェクトで要件が異なる
3. テンプレートから各プロジェクトにコピーすることで柔軟性を保つ

---

## 4. TDD環境の実装案

### 4.1 ディレクトリ構造（提案）

```
# テンプレートリポジトリ
laravel-tdd-template/
├── README.md
├── install.sh                    # インストールスクリプト
└── .claude/
    ├── skills/
    │   ├── tdd-init/
    │   │   └── SKILL.md
    │   ├── tdd-plan/
    │   │   ├── SKILL.md
    │   │   └── templates/
    │   │       └── PLAN.md.template
    │   ├── tdd-plan-review/
    │   │   └── SKILL.md
    │   ├── tdd-red/
    │   │   └── SKILL.md
    │   ├── tdd-green/
    │   │   └── SKILL.md
    │   ├── tdd-refactor/
    │   │   └── SKILL.md
    │   ├── tdd-review/
    │   │   └── SKILL.md
    │   └── laravel-quality/
    │       ├── SKILL.md
    │       └── scripts/
    │           ├── phpstan-check.sh
    │           └── coverage-check.sh
    ├── commands/
    │   ├── tdd-init.md
    │   ├── tdd-plan.md
    │   ├── tdd-red.md
    │   ├── tdd-green.md
    │   ├── tdd-refactor.md
    │   └── tdd-commit.md
    └── config/
        ├── phpstan.neon.template
        ├── phpunit.xml.template
        └── tdd-metrics.json

# 既存プロジェクトへの適用
cd your-laravel-project
git clone https://github.com/yourname/laravel-tdd-template .tdd-template
./.tdd-template/install.sh
```

### 4.2 インストールスクリプト

```bash
#!/bin/bash
# install.sh

echo "=== Laravel TDD Environment Setup ==="

# 1. .claudeディレクトリ作成
mkdir -p .claude/skills
mkdir -p .claude/commands
mkdir -p docs/tdd

# 2. Skillsをコピー
cp -r .tdd-template/.claude/skills/* .claude/skills/

# 3. コマンドをコピー
cp -r .tdd-template/.claude/commands/* .claude/commands/

# 4. CLAUDE.mdを生成（既存がなければ）
if [ ! -f CLAUDE.md ]; then
    cat > CLAUDE.md <<'EOF'
# Project Configuration

## TDD Workflow

This project uses strict TDD workflow enforced by Claude Skills.

**Workflow**: INIT → PLAN → PLAN_REVIEW → RED → GREEN → REFACTOR → REVIEW → COMMIT

**Rules**:
- Never skip phases
- Always follow the current phase's constraints
- Use `/tdd-*` commands to navigate phases

## Tech Stack

- PHP 8.2+
- Laravel 11.x
- PHPUnit/Pest
- PHPStan Level 9
- Laravel Pint

## Quality Standards

- Test Coverage: ≥80%
- PHPStan Level: 9
- Cyclomatic Complexity: ≤10
EOF
fi

# 5. .gitignore更新
if ! grep -q "CLAUDE.local.md" .gitignore; then
    echo "CLAUDE.local.md" >> .gitignore
fi

# 6. 初期化完了
echo "✅ TDD Environment installed successfully!"
echo ""
echo "Next steps:"
echo "1. Review CLAUDE.md"
echo "2. Run: /tdd-init 'Your feature description'"
echo "3. Follow the TDD workflow"
```

### 4.3 Skill例: tdd-plan

```markdown
---
name: tdd-plan
description: PLANフェーズ用。実装計画ドキュメントのみを作成し、実装コードは一切書かない。ユーザーが「plan」「計画」「設計」と言った時、または /tdd-plan コマンド実行時に使用。
allowed-tools: Read, Write, Grep, Glob
---

# TDD PLAN Phase

あなたは現在 **PLANフェーズ** にいます。

## このフェーズでやること

✅ `docs/tdd/PLAN.md` の作成
✅ アーキテクチャ設計の文書化
✅ テストケースの洗い出し
✅ 実装範囲の明確化

## このフェーズで絶対にやってはいけないこと

❌ 実装コードを書くこと（app/, tests/ 等への書き込み禁止）
❌ テストコードを書くこと
❌ データベースマイグレーションを作成すること
❌ ユーザーの承認なしに次のフェーズに進むこと

## 出力フォーマット

`docs/tdd/PLAN.md` に以下の構造で記述:

```markdown
# [機能名] 実装計画

## 概要
[1-2段落で機能の説明]

## 実装範囲

### 対象ファイル
- `app/Models/User.php` - プロフィール関連フィールド追加
- `app/Http/Controllers/ProfileController.php` - 新規作成
- ...

### 対象外
- 通知機能（次フェーズ）
- ...

## アーキテクチャ設計

### データモデル
...

### API設計
...

## テストケース一覧

### Feature Tests
1. `tests/Feature/ProfileUpdateTest.php`
   - ユーザーが自分のプロフィールを更新できる
   - バリデーションエラーが正しく返される
   - ...

### Unit Tests
...

## 見積もり
- テスト作成: 2時間
- 実装: 3時間
- リファクタリング: 1時間

## 依存関係
- なし

## リスク
...
```

## 次のステップ

PLANドキュメントを作成したら:

1. ユーザーにレビューを依頼
2. 承認されたら `/tdd-plan-review` へ進むよう促す
3. **絶対に勝手に実装を始めない**
```

### 4.4 スラッシュコマンド例

```markdown
<!-- .claude/commands/tdd-plan.md -->
# /tdd-plan コマンド

TDDワークフローのPLANフェーズを開始します。

## 実行内容

1. 現在の状態を確認（.tdd-state.jsonから）
2. `tdd-plan` Skillを有効化
3. INIT.mdの内容を読み取る
4. PLAN.mdを作成
5. ユーザーにレビューを依頼

## 制約

- INITフェーズが完了していない場合はエラー
- 既にPLAN.mdが存在する場合は上書き確認

## 使い方

```bash
/tdd-plan
```
```

---

## 5. Skills vs MCP vs スラッシュコマンド 使い分け

| 機能 | 使うもの | 理由 |
|------|---------|------|
| フェーズの制約（実装コード書かない等） | **Skills** | Claudeの振る舞いを制御 |
| ワークフロー実行（/tdd-plan等） | **スラッシュコマンド** | ユーザーが明示的に実行 |
| PHPStan/PHPUnit実行 | **MCP** | 外部ツールとの統合 |
| TDD知識・ベストプラクティス | **Skills** | 手順的知識の提供 |
| プロジェクト固有設定 | **CLAUDE.md** | プロジェクト文脈の提供 |

### 実装例

```
ユーザー: /tdd-plan
   ↓
スラッシュコマンド: tdd-planスキルを呼び出す
   ↓
Skills (tdd-plan): 「実装コードを書かない」制約を適用
   ↓
Skills (tdd-plan): PLAN.md作成の手順を実行
   ↓
ユーザーがレビュー
   ↓
ユーザー: /tdd-red
   ↓
Skills (tdd-red): 「テストだけ書く」制約を適用
   ↓
テスト作成
   ↓
ユーザー: /tdd-gate-check
   ↓
MCP (PHPUnit): テスト実行して全部失敗することを確認
```

---

## 6. 推奨実装ステップ

### Phase 1: 最小構成で試す（1日）

1. **1つのSkillを作る**
   ```bash
   mkdir -p .claude/skills/tdd-plan
   # SKILL.mdを作成
   ```

2. **1つのスラッシュコマンドを作る**
   ```bash
   mkdir -p .claude/commands
   # tdd-plan.mdを作成
   ```

3. **動作確認**
   - `/tdd-plan` を実行
   - 実装コードを書かないことを確認

### Phase 2: TDDワークフロー全体（1週間）

4. すべてのフェーズのSkillsを作成
5. すべてのスラッシュコマンドを作成
6. CLAUDE.mdで全体設定

### Phase 3: MCP統合（1週間）

7. PHPStan MCP作成
8. PHPUnit MCP作成
9. Laravel Pint MCP作成

### Phase 4: テンプレート化（数日）

10. install.shスクリプト作成
11. 他のプロジェクト（Django/Flask/WordPress）用テンプレート作成

---

## 7. まとめ

### ✅ Skills適用がベスト

あなたのユースケース（「Claude Codeが勝手に実装するのを防ぐ」）には、**Skillsがベストソリューション**です。

理由:
1. **フェーズごとの制約を強制できる**（`allowed-tools`で書き込み禁止等）
2. **自動的に発動する**（ユーザーが明示しなくても）
3. **プロジェクト固有にカスタマイズ可能**（`.claude/skills/`）
4. **gitで管理・共有できる**

### 🎯 推奨アーキテクチャ

```
プロジェクト固有 Skills + スラッシュコマンド + (将来的に)MCP
```

1. **Skills**: フェーズごとの制約・ワークフロー
2. **スラッシュコマンド**: ユーザー操作のエントリーポイント
3. **MCP**: 外部ツール統合（PHPStan等）
4. **CLAUDE.md**: プロジェクト設定

### 📦 配布方法

**テンプレートリポジトリ + install.sh**

```bash
git clone https://github.com/yourname/laravel-tdd-template .tdd-template
./.tdd-template/install.sh
```

- ✅ 簡単にインストール可能
- ✅ プロジェクトごとにカスタマイズ可能
- ✅ gitで管理できる
- ✅ チーム共有可能

### 🚀 次のアクション

1. **小さく始める**: tdd-planスキル1つを作成して動作確認
2. **段階的に拡大**: 他のフェーズを追加
3. **MCP統合**: 品質チェック自動化
4. **テンプレート化**: 他プロジェクトに展開

---

*調査完了日: 2025-10-22*
