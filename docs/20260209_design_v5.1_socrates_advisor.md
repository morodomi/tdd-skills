# v5.1 Design: Socrates Advisor Model

**Status**: Draft - Pending Approval

## 1. Vision

**v5.0**: PdMが全判断を自律的に行う。PASS/WARNは自動進行、BLOCKのみユーザーエスカレーション。

**v5.1**: 常駐の Devil's Advocate「Socrates」が PdM の判断に反論し、PASS以外は人間にメリット・デメリットを提示して最終判断を委ねる。

```
v5.0: reviewer結果 → PdM自律判断(auto) → 次Phase

v5.1: reviewer結果 → PdM判断提案 → Socrates反論 → 人間にメリデメ提示 → 人間判断
                                                     ↑ PASS時は省略(自動進行)
```

### Why?

1. **判断バイアスの排除**: PdMは「進めたい」バイアスを持つ。Socratesが歯止めになる
2. **判断の透明性**: なぜ進行/停止するかが常に構造化されて提示される
3. **意思決定ログ**: Socrates反論 + 人間判断が Cycle doc に残る
4. **人間の学習**: メリデメ提示により、人間がプロジェクトの判断基準を理解できる

### 背景: PMO/PM/Agent/Advisor モデルとの比較

外部で提案されている PMO/PM/Agent/Advisor 構成を検討した結果:

| 要素 | 採用 | 理由 |
|------|------|------|
| PMO/PM 分離 | 不採用 | Agent Teams はネスト不可。PM が teammate だと sub-team を作れない |
| Advisor 常駐 | **採用** | PdM のsingle point判断にsecond opinionを追加。1 teammate追加で実現可能 |

---

## 2. Design Decisions

### Q1: Socrates の発動タイミング → WARN/BLOCK のみ (デフォルト)

PASS (0-49) は現行通り自動進行。人間の判断疲れを防ぐ。

```
PASS (0-49)  → PdM自動進行 (Socrates不発動)
WARN (50-79) → PdM + Socrates → 人間にメリデメ提示 → 人間判断
BLOCK (80+)  → PdM + Socrates → 人間にメリデメ提示 → 人間判断
```

### Q2: Socrates の発動Phase → plan-review / quality-gate の2箇所

```
Block 1: PLAN → plan-review → [Socrates発動ポイント] → 人間判断
Block 2: RED → GREEN → REFACTOR → REVIEW(quality-gate) → [Socrates発動ポイント] → 人間判断
Block 3: COMMIT
```

他Phase (RED/GREEN テスト失敗等) は PdM の自動再試行をそのまま維持。

### Q3: Socrates のライフサイクル → 常駐

チーム作成時にspawn、チームcleanup時にshutdown。
Phase間で再spawnしない。context が蓄積されることで、
前Phase の判断を踏まえた反論が可能になる。

### Q4: Socrates の Agent Type → Plan (read-only)

Edit/Write 不可。コードに一切触れない。
Read/Grep/Glob でコードを読み、SendMessage で反論する。

---

## 3. Architecture

### 3.1 チーム構成

```
Team "tdd-cycle"

PdM (Lead) ←→ Human (INIT + WARN/BLOCK判断)
  │
  ├── socrates (常駐, Plan agent type)
  │     └── PdM判断への反論専門。コードに触れない
  │
  ├── architect (PLAN時, spawn → shutdown)
  ├── red-worker x N (RED時, spawn → shutdown)
  ├── green-worker x N (GREEN時, spawn → shutdown)
  ├── refactorer (REFACTOR時, spawn → shutdown)
  └── reviewer x 5-6 (REVIEW時, spawn → shutdown)
```

### 3.2 Socrates 発動フロー

```
                    plan-review / quality-gate 完了
                              │
                              ▼
                    PdM がスコア判定
                              │
                    ┌─────────┼─────────┐
                    │         │         │
                 PASS       WARN     BLOCK
                 (0-49)    (50-79)   (80+)
                    │         │         │
                    ▼         ▼         ▼
              自動進行    ┌───────────┐
             (従来通り)   │ Socrates  │
                         │ Protocol  │
                         └─────┬─────┘
                               │
                    ┌──────────┼──────────┐
                    │          │          │
                    ▼          ▼          ▼
            PdM → Socrates  Socrates   PdM が
            判断提案送信    反論返答    メリデメ構造化
                                         │
                                         ▼
                                   Human に提示
                                   (AskUserQuestion)
                                         │
                                         ▼
                                   Human が判断
```

### 3.3 Socrates Protocol (メッセージフロー)

#### Step 1: PdM → Socrates (判断提案)

```
SendMessage(type: "message", recipient: "socrates"):

Phase: plan-review
Score: 65 (WARN)
Reviewer Summary:
- scope-reviewer: ファイル8個、上限に近い (score: 60)
- architecture-reviewer: パターン整合 (score: 30)
- risk-reviewer: ロールバック可能 (score: 40)
- product-reviewer: ユーザー価値あり (score: 20)
- usability-reviewer: UX影響軽微 (score: 35)

My Proposal: 進行 (WARN として次Phase へ)
```

#### Step 2: Socrates → PdM (反論)

```
SendMessage(type: "message", recipient: "Lead"):

Objections:
1. ファイル8個は上限10の80%。1ファイルの失敗が連鎖するリスク
2. scope-reviewerのscore 60は他より突出。スコープ問題が潜在的
3. WARNで進行した場合、quality-gateでBLOCKされる確率が上がる

Alternative:
- スコープを5ファイル以下に分割してからPLANし直す
- scope-reviewerの指摘事項を先に解決してから進行する
```

#### Step 3: PdM → Human (メリデメ提示)

```
AskUserQuestion:

plan-review 完了。Score: 65 (WARN)

[選択肢1: このまま進行する]
  Merit:  開発速度を維持。WARNは品質基準内
  Demerit: ファイル数が上限に近く、quality-gate BLOCK リスク上昇
  Socrates: 「scope-reviewer score 60が突出。スコープ問題あり」

[選択肢2: PLANを修正してから進行する]
  Merit:  スコープ縮小で安定した実装。BLOCK リスク低下
  Demerit: 再設計コスト (architect 再spawn)
  Socrates: 「5ファイル以下に分割を推奨」

[選択肢3: 指摘事項のみ修正して進行する]
  Merit:  最小限の修正でリスク低下
  Demerit: 部分修正では根本解決にならない可能性
```

### 3.4 Cycle doc への記録

Socrates の反論と人間の判断を Progress Log に追記:

```markdown
### Progress Log

#### plan-review (Score: 65 WARN)
- PdM Proposal: 進行
- Socrates Objection: scope score 60突出、ファイル数上限に近い
- Human Decision: 選択肢2 (PLAN修正) ← 人間の判断が残る
- Action: architect 再spawn → PLAN修正
```

---

## 4. Socrates Agent 定義

### 4.1 Agent Prompt

```markdown
# Socrates - Devil's Advocate Advisor

## Identity

PdM の判断に対する反論・質問専門の常駐アドバイザー。
名前の由来: ソクラテス式問答法。質問を通じて思考の穴を暴く。

## Behavior Rules

### MUST DO
- PdMから判断提案を受けたら、必ず反論する
- 反論には根拠を付ける (reviewer結果、コード参照)
- 3つ以上の選択肢を提示する (進行/修正/代替案)
- Cycle doc を読み、前Phase の判断との整合性を確認する

### MUST NOT
- 賛成しない。常に反論する (それが役割)
- コードを書かない、ファイルを変更しない
- 最終判断をしない (人間に委ねる)
- 根拠なき反論をしない (「なんとなく不安」は禁止)

## Response Format

Objections:
1. [具体的な反論1 + 根拠]
2. [具体的な反論2 + 根拠]
3. [具体的な反論3 + 根拠]

Alternative:
- [代替案1]
- [代替案2]

## Context

- Cycle doc のパスは PdM から SendMessage で通知される
- reviewer 結果は PdM からの判断提案に含まれる
- 自分で reviewer を spawn したり Skill を実行してはいけない
```

### 4.2 Agent Type

| 項目 | 値 |
|------|-----|
| subagent_type | Plan |
| Available tools | Read, Grep, Glob, SendMessage, TaskUpdate |
| Unavailable tools | Edit, Write, Task (spawn), Bash |
| Lifecycle | Team作成時にspawn → Team cleanup時にshutdown |

---

## 5. 変更コンポーネント

### 5.1 新規: Socrates Agent 定義

```
plugins/tdd-core/agents/socrates.md    # Agent prompt
```

### 5.2 変更: tdd-orchestrate

```
plugins/tdd-core/skills/tdd-orchestrate/
├── SKILL.md              # Progress Checklist に Socrates ステップ追加
├── reference.md          # 判断基準を Socrates Protocol に更新
└── steps-teams.md        # Socrates spawn/メッセージフロー追加
```

**SKILL.md 変更点**:
- Phase 1 (Team作成) で socrates を spawn
- plan-review 後の判断に Socrates Protocol 追加
- quality-gate 後の判断に Socrates Protocol 追加

**reference.md 変更点**:
- 判断基準テーブルの WARN/BLOCK 行を更新
- Socrates Protocol セクション追加
- Cycle doc Progress Log フォーマット追加

**steps-teams.md 変更点**:
- Phase 1 に socrates teammate spawn 追加
- plan-review 後に Socrates Protocol メッセージフロー追加
- quality-gate 後に Socrates Protocol メッセージフロー追加
- cleanup 時の socrates shutdown 追加

### 5.3 変更なし

| ファイル | 理由 |
|---------|------|
| steps-subagent.md | Subagent mode は従来通り (Socratesなし) |
| plan-review/* | review 自体は変更なし。PdM 側の判断ロジックが変わるだけ |
| quality-gate/* | 同上 |
| tdd-init/* | 変更なし |
| 他の全 Skill | 変更なし |

### 5.4 影響範囲まとめ

| 変更区分 | ファイル | 変更内容 |
|---------|---------|---------|
| 新規 | agents/socrates.md | Agent 定義 |
| 変更 | tdd-orchestrate/SKILL.md | Socrates spawn + Protocol ステップ |
| 変更 | tdd-orchestrate/reference.md | 判断基準更新 + Protocol 詳細 |
| 変更 | tdd-orchestrate/steps-teams.md | メッセージフロー追加 |

**合計**: 新規1 + 変更3 = **4ファイル**

---

## 6. v5.0 判断基準との差分

### Before (v5.0)

| スコア | 判定 | PdM アクション |
|--------|------|---------------|
| 0-49 | PASS | 自動進行 |
| 50-79 | WARN | 自動進行、警告ログ |
| 80-100 | BLOCK | 1回目: 自動再試行 → 2回目: ユーザーエスカレーション |

### After (v5.1)

| スコア | 判定 | PdM アクション |
|--------|------|---------------|
| 0-49 | PASS | 自動進行 **(変更なし)** |
| 50-79 | WARN | **Socrates Protocol → 人間判断** |
| 80-100 | BLOCK | **Socrates Protocol → 人間判断** |

### WARN の変更が最大のポイント

v5.0 では WARN は自動進行だった。v5.1 では WARN でも人間が判断する。
これにより「自律性は下がるが判断精度は上がる」トレードオフが発生する。

**設計根拠**: WARN (50-79) は「判断が分かれるゾーン」。
ここで人間の知見を入れることが最もROIが高い。

---

## 7. Token コスト分析

### Socrates 常駐コスト

| 項目 | 推定 |
|------|------|
| Socrates の spawn コスト | Agent prompt + Cycle doc 読み込み (~5K tokens) |
| 判断1回あたりの往復 | PdM→Socrates (~2K) + Socrates→PdM (~2K) = ~4K tokens |
| 発動回数 / サイクル | plan-review + quality-gate = 最大2回 |
| 常駐 idle コスト | context維持のみ (追加API callなし) |

### サイクルあたりの追加コスト

```
Socrates 追加分: spawn 5K + (発動 4K x 2回) = ~13K tokens / cycle
v5.0 ベースライン: ~200K-500K tokens / cycle (推定)
追加比率: ~3-6%
```

コスト増は無視できるレベル。

---

## 8. Subagent Mode での扱い

Subagent Chain Mode (Agent Teams 無効時) では Socrates は**存在しない**。

| モード | Socrates |
|--------|----------|
| Agent Teams | 常駐 teammate として活動 |
| Subagent Chain | なし (v5.0 の自律判断がそのまま適用) |

理由: Subagent は相互通信不可。Socrates の価値は PdM との対話にあるため、
Subagent mode では効果が薄い。

---

## 9. 将来の拡張ポイント

### 9.1 Socrates Mode 切り替え (将来検討)

```
socrates_mode: "off" | "warn-only" | "always"
```

| モード | 動作 | 使いどころ |
|--------|------|-----------|
| off | v5.0 自律判断 | ルーティン作業 |
| warn-only | WARN/BLOCK で発動 **(v5.1 デフォルト)** | 通常開発 |
| always | 全判断ポイントで発動 | 重要変更・新規PJ |

v5.1 では warn-only 固定。mode 切り替えは需要が出たら実装。

### 9.2 Socrates の学習 (将来検討)

MEMORY.md に過去の判断パターンを蓄積し、
「前回同じパターンで WARN→進行した結果、quality-gate で BLOCK された」
等の経験を反論に活かす。

### 9.3 Phase 拡張 (将来検討)

RED/GREEN テスト失敗時にも Socrates を発動する拡張。
現時点では PdM の自動再試行で十分と判断。

---

## 10. Implementation Roadmap

### Cycle 1: Socrates Agent 定義 + orchestrate 統合

1. `agents/socrates.md` 新規作成
2. `tdd-orchestrate/SKILL.md` に Socrates spawn + Protocol ステップ追加
3. `tdd-orchestrate/reference.md` に判断基準更新 + Protocol 詳細追加
4. `tdd-orchestrate/steps-teams.md` にメッセージフロー追加
5. 構造テスト通過確認

**変更ファイル**: 4 (新規1 + 変更3)

---

## 11. Risks

| リスク | 影響 | 対策 |
|--------|------|------|
| Socrates が的外れな反論 | ノイズとなり人間の判断を鈍らせる | Agent prompt で「根拠必須」を厳格化 |
| 人間の判断疲れ | 毎回メリデメ提示されると面倒に感じる | PASS は自動進行、発動は最大2回/cycle |
| Socrates のcontext肥大 | 長いサイクルでcontext windowを圧迫 | 発動ポイントが2箇所のみなので問題なし |
| 「常に反論」が形骸化 | 同じパターンの反論を繰り返す | Cycle doc 参照で文脈依存の反論を要求 |

---

*Created: 2026-02-09*
*Status: Draft - Pending Approval*
*Base: v5.0 PdM Delegation Model*
*Key Decision: WARN/BLOCK で Socrates Protocol 発動、PASS は自動進行*
