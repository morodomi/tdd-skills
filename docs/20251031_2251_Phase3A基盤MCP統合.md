# Phase 3A: 基盤MCP統合（Git, Filesystem, GitHub）

## 機能概要

ClaudeSkills TDDワークフローに、Anthropic公式のMCPサーバー（Git, Filesystem, GitHub）を統合し、開発プロセスの自動化と安全性を向上させる。

## 背景

### 現状の課題
1. **手動操作の多さ**: git操作、ファイル操作、PR作成などを手動で実行
2. **エラーリスク**: Bash経由のファイル操作には安全性の懸念
3. **GitHub連携の不足**: PR作成やレビュー機能が不足

### MCP統合の利点
1. **自動化の向上**: Gitコミット、PR作成の自動化
2. **安全性の向上**: ファイル操作の権限管理・監査ログ
3. **標準化**: Anthropic公式プロトコルによる統一的な連携

## 要件

### 機能要件

#### FR-01: Git MCP統合
- Git操作（status, add, commit, push, branch）をMCP経由で実行
- tdd-commit Skillでの利用
- コミットメッセージ自動生成の改善

#### FR-02: Filesystem MCP統合
- すべてのSkillでのファイル操作をMCP経由に変更
- 読み取り・書き込み権限の制御
- プロジェクトルート以下のみアクセス許可

#### FR-03: GitHub MCP統合
- PR自動作成機能
- Issue情報の取得（PLAN フェーズ用）
- レビューコメントの取得

### 非機能要件

#### NFR-01: 互換性
- 既存のSkillsとの後方互換性を維持
- MCPが利用できない環境でもフォールバック動作

#### NFR-02: セキュリティ
- GitHub Tokenの安全な管理（環境変数）
- ファイルアクセス制御（プロジェクトルート以下のみ）
- 機密ファイル（.env等）へのアクセス制限

#### NFR-03: パフォーマンス
- MCP経由でも従来と同等以上の速度
- 大量ファイル操作でのタイムアウト対策

### 制約事項

#### C-01: インストール要件
- Node.js環境が必要（MCPサーバーのインストール）
- npm/npx が利用可能であること

#### C-02: 認証要件
- GitHub MCPにはGitHub Personal Access Token必須
- Scopeは最小限（repo, workflow）

## 実装範囲

### スコープ内（Phase 3A）

1. **MCPサーバーインストールスクリプト**
   - install-mcp.sh の作成
   - Git, Filesystem, GitHub MCPの自動インストール

2. **設定ファイルテンプレート**
   - .claude/config.json.example の作成
   - MCPサーバー設定の記述

3. **Skills更新**
   - tdd-commit Skillの更新（Git MCP, GitHub MCP利用）
   - 全Skillsへのフォールバック処理追加

4. **ドキュメント整備**
   - インストールガイド
   - トラブルシューティング

### スコープ外（Phase 3B以降）

1. 言語別MCPサーバー（Ruff, pytest, PHPStan等）
2. カスタムMCPサーバーの開発
3. Semgrep等のセキュリティチェックMCP

---

## TDDワークフロー

### フェーズ進行状況

```
[完了] INIT (初期化) ← 現在ここ
[次] PLAN (計画)
[ ] RED (テスト作成)
[ ] GREEN (実装)
[ ] REFACTOR (リファクタリング)
[ ] REVIEW (品質検証)
[ ] DOC (ドキュメント)
[ ] COMMIT (コミット)
[ ] DEPLOY (デプロイ)
```

---

## INIT (初期化)

### 実施内容

#### 1. TDDドキュメント作成
- ファイル名: `docs/20251031_2251_Phase3A基盤MCP統合.md`
- 機能概要、背景、要件、実装範囲を定義

#### 2. 関連調査ドキュメント
- 参照: `docs/20251031_1500_MCP統合調査.md`
- MCP統合戦略の詳細は調査ドキュメント参照

#### 3. 成果物の確認
- ✅ TDDドキュメント作成完了
- ✅ 機能要件明確化
- ✅ スコープ定義完了

### 次のステップ

PLANフェーズでは、以下を詳細化します：

1. **MCPインストールスクリプト設計**
   - install-mcp.sh の詳細仕様
   - エラーハンドリング
   - 環境チェック

2. **設定ファイル設計**
   - .claude/config.json の構造
   - 環境変数の管理方法
   - セキュリティ設定

3. **Skills更新計画**
   - tdd-commit Skillの変更内容
   - フォールバック処理の実装方針
   - テスト計画

---

## PLAN (計画)

### 実装ファイル

#### 新規作成ファイル

1. **scripts/install-mcp.sh**
   - 目的: Git, Filesystem, GitHub MCPサーバーのインストール自動化
   - 機能:
     - Node.js/npm環境チェック
     - `claude mcp add`コマンドを使用してMCPサーバーを追加
     - 既存の.claude/config.jsonを保持
     - インストール確認（`claude mcp list`）
     - エラーハンドリング

3. **docs/MCP_INSTALLATION.md**
   - 目的: MCPインストール・設定ガイド
   - 内容:
     - 前提条件
     - インストール手順
     - 設定方法
     - トラブルシューティング

#### 更新ファイル

4. **templates/laravel/.claude/skills/tdd-commit/SKILL.md**
   - 変更内容:
     - Git MCPを使用したコミット処理の追加
     - GitHub MCPを使用したPR作成の追加
     - フォールバック処理（MCP未利用時は従来のBash）
     - エラーハンドリング強化

5. **README.md**
   - 変更内容:
     - Phase 3A完了の記録
     - MCPインストール手順へのリンク
     - 新しい機能の説明

### タスク分割

#### タスク1: MCPインストールスクリプト作成
**優先度**: 高
**見積もり**: 40分

**詳細**:
- [ ] scripts/install-mcp.sh の作成
- [ ] 環境チェック機能（Node.js, npm, claude）
- [ ] `claude mcp add`コマンドを使用してMCPサーバーを追加
  - Git MCP: `claude mcp add --transport stdio git -- npx -y @modelcontextprotocol/server-git`
  - Filesystem MCP: `claude mcp add --transport stdio filesystem -- npx -y @modelcontextprotocol/server-filesystem`
  - GitHub MCP: `claude mcp add --transport stdio github --env GITHUB_TOKEN=${GITHUB_TOKEN} -- npx -y @modelcontextprotocol/server-github`
- [ ] 既存MCPサーバーの重複チェック（`claude mcp list`）
- [ ] インストール確認
- [ ] エラーハンドリング
- [ ] 実行権限の付与（chmod +x）

**成果物**:
- scripts/install-mcp.sh

#### タスク2: インストールガイド作成
**優先度**: 高
**見積もり**: 30分

**詳細**:
- [ ] docs/MCP_INSTALLATION.md の作成
- [ ] 前提条件の記述（Node.js, npm, Claude Code）
- [ ] インストール手順の記述（scripts/install-mcp.sh使用）
- [ ] 手動インストール手順（claude mcp addコマンド）
- [ ] GitHub Token設定方法
- [ ] トラブルシューティング

**成果物**:
- docs/MCP_INSTALLATION.md

#### タスク3: tdd-commit Skill更新
**優先度**: 高
**見積もり**: 45分

**詳細**:
- [ ] Git MCP利用のコミット処理追加
- [ ] GitHub MCP利用のPR作成追加
- [ ] MCP利用可能性チェック
- [ ] フォールバック処理（従来のBash）
- [ ] エラーハンドリング

**成果物**:
- templates/laravel/.claude/skills/tdd-commit/SKILL.md（更新版）

#### タスク4: README更新
**優先度**: 低
**見積もり**: 10分

**詳細**:
- [ ] Phase 3A完了を開発状況に追加
- [ ] MCPインストール手順へのリンク追加
- [ ] 最終更新日の更新

**成果物**:
- README.md（更新版）

### 見積もり

| タスク | 見積もり時間 |
|-------|-----------|
| タスク1: MCPインストールスクリプト | 40分 |
| タスク2: インストールガイド | 30分 |
| タスク3: tdd-commit Skill更新 | 45分 |
| タスク4: README更新 | 10分 |
| **合計** | **2時間5分** |

### 実装順序

```
1. タスク2（インストールガイド）
   ↓
2. タスク1（MCPインストールスクリプト）
   ↓
3. タスク3（tdd-commit Skill更新）
   ↓
4. タスク4（README更新）
```

**理由**:
- ガイドを先に作成し、インストール手順を明確化
- インストールスクリプトは手動手順を自動化したもの
- Skill更新は最後に全体の流れを理解してから実装
- READMEは最後に全体を俯瞰して更新

### ディレクトリ構造

```
ClaudeSkills/
├── scripts/
│   ├── install.sh              # 既存
│   └── install-mcp.sh          # 新規（claude mcp add使用）
├── docs/
│   ├── 20251031_1500_MCP統合調査.md
│   ├── 20251031_2251_Phase3A基盤MCP統合.md
│   └── MCP_INSTALLATION.md     # 新規
├── templates/
│   └── laravel/
│       └── .claude/
│           └── skills/
│               └── tdd-commit/
│                   └── SKILL.md  # 更新
└── README.md                    # 更新

注: .claude/config.jsonは既存設定を保持したまま自動更新される
```

### 品質基準

#### QC-01: インストールスクリプト
- [ ] Node.js/npm/claude環境チェックが正常に動作
- [ ] claude mcp addコマンドが正しく実行される
- [ ] 既存のMCPサーバー重複チェックが動作
- [ ] MCPサーバーが正しくインストールされる（claude mcp listで確認）
- [ ] エラー時に適切なメッセージが表示される
- [ ] 実行権限が正しく設定される
- [ ] 既存の.claude/config.jsonが保持される

#### QC-02: tdd-commit Skill
- [ ] MCP利用時のコミットが正常に動作
- [ ] MCP未利用時のフォールバックが動作
- [ ] PR作成が正常に動作
- [ ] エラーハンドリングが適切

#### QC-03: ドキュメント
- [ ] インストール手順が明確（自動・手動両方）
- [ ] claude mcp addコマンドの説明が分かりやすい
- [ ] GitHub Token設定方法が明確
- [ ] トラブルシューティングが充実
- [ ] README更新が適切
- [ ] リンクが正しく機能

#### QC-04: セキュリティ
- [ ] GitHub Tokenが環境変数から読み込まれる
- [ ] ファイルアクセスがプロジェクトルート以下に制限
- [ ] 機密情報がハードコードされていない

### 技術的検討事項

#### 検討1: MCPサーバーのインストール方法
**選択肢**:
- A. `claude mcp add`コマンドを使用
- B. 手動で.claude/config.jsonを編集
- C. npm global installのみ

**決定**: A（`claude mcp add`コマンド）

**理由**:
- Claude Code公式の推奨方法
- 既存設定を保持したまま追加可能
- 設定ミスのリスクが低い
- `claude mcp list`で設定確認が容易

#### 検討2: フォールバック処理
**選択肢**:
- A. MCP利用を必須とする
- B. MCP未利用時は従来のBashにフォールバック
- C. 両方のコードを並列実装

**決定**: B（フォールバック）

**理由**:
- 既存ユーザーへの影響を最小化
- 段階的な移行が可能
- 環境によってはMCPが利用できない場合がある

#### 検討3: GitHub Token管理
**選択肢**:
- A. .claude/config.jsonに直接記述
- B. 環境変数から読み込み
- C. 専用のsecrets管理ツール

**決定**: B（環境変数）

**理由**:
- セキュリティベストプラクティス
- .gitignoreでの除外不要
- CI/CD環境でも利用しやすい

### リスクと対策

| リスク | 影響度 | 発生確率 | 対策 |
|-------|--------|---------|------|
| Node.js環境がない | 高 | 中 | インストールガイドで明示、フォールバック処理 |
| GitHub Token設定漏れ | 中 | 高 | 明確なエラーメッセージ、設定ガイド充実 |
| MCP接続エラー | 中 | 中 | フォールバック処理、リトライロジック |
| 既存Skillsとの非互換 | 低 | 低 | 後方互換性維持、十分なテスト |

### 次のステップ

PLANレビュー完了後、REDフェーズでテストケースを作成します。

**REDフェーズで作成するテストケース**:
- TC-01: MCPインストールスクリプトのテスト（claude mcp add実行確認）
- TC-02: 既存設定保持のテスト（.claude/config.json上書き防止）
- TC-03: tdd-commit Skillのテスト（MCP利用）
- TC-04: tdd-commit Skillのテスト（フォールバック）
- TC-05: インストールガイドの検証（手動・自動両方の手順）

---

## RED (テスト作成)

### テスト方針

Phase 3Aは主にインストールスクリプトとドキュメントの作成であり、自動テストではなく手動テストケースを作成します。

### テストケース一覧

#### TC-01: MCPインストールスクリプトのテスト

**目的**: `scripts/install-mcp.sh`が正しくMCPサーバーをインストールできることを確認

**前提条件**:
- Node.js (v18以上) がインストール済み
- npm がインストール済み
- Claude Code がインストール済み

**テスト手順**:

1. **環境チェックのテスト**
   ```bash
   # スクリプト実行
   cd /path/to/ClaudeSkills
   bash scripts/install-mcp.sh
   ```

   期待結果:
   - Node.js バージョンが表示される
   - npm バージョンが表示される
   - claude コマンドが利用可能であることが確認される

2. **MCPサーバーインストールのテスト**
   ```bash
   # インストール後の確認
   claude mcp list
   ```

   期待結果:
   - `git` MCPサーバーが表示される
   - `filesystem` MCPサーバーが表示される
   - `github` MCPサーバーが表示される（GITHUB_TOKEN設定済みの場合）

3. **重複インストールの防止テスト**
   ```bash
   # 2回目の実行
   bash scripts/install-mcp.sh
   ```

   期待結果:
   - 既存のMCPサーバーは上書きされない
   - 「すでにインストール済み」のメッセージが表示される

**失敗条件**:
- 環境チェックでエラーが発生する
- MCPサーバーがインストールされない
- 既存のMCPサーバーが削除される

**テスト結果**: (GREENフェーズ後に記録)

---

#### TC-02: 既存設定保持のテスト

**目的**: 既存の`.claude/config.json`が保持されることを確認

**前提条件**:
- `.claude/config.json`に既存のMCPサーバー設定がある
- 例: aws-knowledge MCPサーバーが設定済み

**テスト手順**:

1. **既存設定の確認**
   ```bash
   # インストール前のMCPリスト
   claude mcp list > before.txt
   cat before.txt
   ```

2. **インストールスクリプト実行**
   ```bash
   bash scripts/install-mcp.sh
   ```

3. **インストール後の設定確認**
   ```bash
   # インストール後のMCPリスト
   claude mcp list > after.txt
   cat after.txt
   ```

4. **差分確認**
   ```bash
   # before.txtの内容がafter.txtに含まれているか確認
   diff before.txt after.txt
   ```

**期待結果**:
- before.txtに含まれていたMCPサーバーがすべてafter.txtにも存在
- 新しいMCPサーバー（git, filesystem, github）が追加されている
- 既存のMCPサーバー設定は変更されていない

**失敗条件**:
- 既存のMCPサーバーが削除される
- 既存のMCPサーバー設定が変更される

**テスト結果**: (GREENフェーズ後に記録)

---

#### TC-03: tdd-commit Skillのテスト（MCP利用）

**目的**: MCP経由でのgitコミット・PR作成が正常に動作することを確認

**前提条件**:
- Git MCPサーバーがインストール済み
- GitHub MCPサーバーがインストール済み
- GITHUB_TOKEN が環境変数に設定済み
- テスト用Gitリポジトリが準備済み

**テスト手順**:

1. **テスト環境準備**
   ```bash
   # テストリポジトリ作成
   mkdir -p /tmp/test-mcp-commit
   cd /tmp/test-mcp-commit
   git init
   echo "# Test" > README.md
   git add README.md
   git commit -m "Initial commit"
   ```

2. **Claude Codeでtdd-commitスキル起動**
   - Phase 3A実装完了後、テスト用の変更を作成
   - tdd-commit Skillを実行
   - MCP経由でコミットされることを確認

3. **コミット確認**
   ```bash
   # コミット履歴確認
   git log --oneline -n 5

   # 最新コミットの詳細確認
   git show HEAD
   ```

**期待結果**:
- コミットが正常に作成される
- コミットメッセージが適切に生成される
- Co-Authored-By: Claude が含まれる
- MCPツールが使用されたことがログに記録される（デバッグモード時）

**失敗条件**:
- コミットが作成されない
- エラーメッセージが表示される
- Bashフォールバックが実行される（MCP利用時は使われるべき）

**テスト結果**: (GREENフェーズ後に記録)

---

#### TC-04: tdd-commit Skillのテスト（フォールバック）

**目的**: MCP未インストール環境で従来のBashコマンドにフォールバックすることを確認

**前提条件**:
- Git MCPサーバーが**未インストール**
- テスト用Gitリポジトリが準備済み

**テスト手順**:

1. **MCPサーバーの一時削除**
   ```bash
   # Gitサーバーを削除（テスト用）
   claude mcp remove git
   claude mcp remove github

   # 削除確認
   claude mcp list
   ```

2. **Claude Codeでtdd-commitスキル起動**
   - Phase 3A実装完了後、テスト用の変更を作成
   - tdd-commit Skillを実行
   - Bash経由でコミットされることを確認

3. **コミット確認**
   ```bash
   # コミット履歴確認
   git log --oneline -n 5

   # 最新コミットの詳細確認
   git show HEAD
   ```

**期待結果**:
- コミットが正常に作成される（Bash経由）
- 「MCP未利用、Bashコマンドを使用」などのメッセージが表示される
- コミット機能自体は正常に動作する

**失敗条件**:
- コミットが作成されない
- エラーで停止する
- フォールバックが動作しない

**テスト後処理**:
```bash
# MCPサーバーを再インストール
bash scripts/install-mcp.sh
```

**テスト結果**: (GREENフェーズ後に記録)

---

#### TC-05: インストールガイドの検証

**目的**: `docs/MCP_INSTALLATION.md`の手順が正確で分かりやすいことを確認

**前提条件**:
- 新規環境（MCPサーバー未インストール）
- Node.js, npm, Claude Codeはインストール済み

**テスト手順**:

1. **自動インストール手順のテスト**
   - `docs/MCP_INSTALLATION.md`の「自動インストール」セクションを参照
   - 記載されたコマンドを順番に実行
   ```bash
   # ドキュメントに記載されたコマンドを実行
   cd /path/to/ClaudeSkills
   bash scripts/install-mcp.sh
   ```

   期待結果:
   - 手順に従って実行すると、エラーなくインストールが完了
   - `claude mcp list`で3つのMCPサーバーが表示される

2. **手動インストール手順のテスト**
   - 別の環境で「手動インストール」セクションを参照
   - 記載された`claude mcp add`コマンドを実行
   ```bash
   # ドキュメントに記載されたコマンドを実行
   claude mcp add --transport stdio git -- npx -y @modelcontextprotocol/server-git
   claude mcp add --transport stdio filesystem -- npx -y @modelcontextprotocol/server-filesystem
   claude mcp add --transport stdio github --env GITHUB_TOKEN=${GITHUB_TOKEN} -- npx -y @modelcontextprotocol/server-github
   ```

   期待結果:
   - 手順に従って実行すると、エラーなくインストールが完了
   - 自動インストールと同じ結果になる

3. **トラブルシューティングの検証**
   - 意図的にエラーを発生させる（例: Node.js未インストール環境）
   - トラブルシューティングセクションの手順で解決できるか確認

**期待結果**:
- 手順が明確で迷わず実行できる
- コマンドが正しく動作する
- エラー時の対処法が記載されている
- 初心者でも理解できる説明

**失敗条件**:
- 手順が不明確で実行できない
- コマンドが誤っている
- トラブルシューティングで解決できない

**テスト結果**: (GREENフェーズ後に記録)

---

### テスト環境

| 項目 | 要件 |
|-----|------|
| OS | macOS (Darwin 24.6.0) |
| Node.js | v18以上 |
| npm | 最新版 |
| Claude Code | 最新版 |
| Git | 2.x以上 |
| シェル | bash |

### テスト実行順序

```
TC-01（スクリプト基本動作）
  ↓
TC-02（既存設定保持）
  ↓
TC-05（ドキュメント検証）
  ↓
TC-03（MCP利用）
  ↓
TC-04（フォールバック）
```

### テスト完了基準

- [ ] TC-01: MCPインストールスクリプトのテスト - 合格
- [ ] TC-02: 既存設定保持のテスト - 合格
- [ ] TC-03: tdd-commit Skillのテスト（MCP利用） - 合格
- [ ] TC-04: tdd-commit Skillのテスト（フォールバック） - 合格
- [ ] TC-05: インストールガイドの検証 - 合格

すべてのテストケースが合格するまでGREENフェーズを繰り返します。

---

## GREEN (実装)

*GREENフェーズで記述*

---

## REFACTOR (リファクタリング)

*REFACTORフェーズで記述*

---

## REVIEW (品質検証)

*REVIEWフェーズで記述*

---

## DOC (ドキュメント)

*DOCフェーズで記述*

---

## COMMIT (コミット)

*COMMITフェーズで記述*

---

## DEPLOY (デプロイ)

*DEPLOYフェーズで記述*

---

## 参考情報

### 関連ドキュメント
- [MCP統合調査](20251031_1500_MCP統合調査.md)
- [要件定義書](20251022_1328_要件定義.md)
- [README.md](../README.md)

### 公式リソース
- [Model Context Protocol](https://modelcontextprotocol.io/)
- [MCP Servers Repository](https://github.com/modelcontextprotocol/servers)

---

**作成日**: 2025-10-31 22:51
**最終更新**: 2025-10-31 22:51
**ステータス**: INIT完了、PLAN開始待ち
