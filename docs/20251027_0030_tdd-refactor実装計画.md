# Laravel用tdd-refactor Skill 実装計画

**作成日時**: 2025-10-27 00:30
**対象**: templates/laravel/.claude/skills/tdd-refactor/

---

## ユーザーストーリー

**As a** Laravel開発者
**I want to** GREENフェーズで作成した実装をリファクタリングしたい
**So that** テストを維持しながらコードの品質を改善できる

---

## 受け入れ基準

### シナリオ1: tdd-refactor Skillが正しく発動する

**Given** ユーザーがLaravelプロジェクトで作業している
**And** GREENフェーズで実装が完了している
**When** 以下のいずれかの条件を満たす
  - ユーザーが「refactor」「リファクタリング」と言う
  - `/tdd-refactor` コマンドを実行する
  - GREENフェーズが完了して次のフェーズへ進む
**Then** tdd-refactor Skillが自動的に読み込まれる
**And** テストが通っていることを確認してから開始する

### シナリオ2: テストを維持しながらリファクタリングする

**Given** tdd-refactor Skillが発動している
**And** すべてのテストが通っている
**When** リファクタリングを行う
**Then** 各変更後にテストを実行する
**And** テストが通り続けることを確認する
**And** テストが失敗したら変更を戻す

### シナリオ3: コード品質を改善する

**Given** tdd-refactor Skillが発動している
**When** リファクタリングを行う
**Then** 以下の改善を行う
  - 重複コードの削除（DRY原則）
  - マジックナンバーの定数化
  - 長いメソッドの分割
  - ネーミングの改善
  - 複雑な条件式の簡潔化

### シナリオ4: 品質チェックツールを実行する

**Given** リファクタリングが完了した
**When** 完了フェーズに入る
**Then** PHPStanを実行する（品質基準: Level 8）
**And** Laravel Pintを実行する（コード整形）
**And** テストカバレッジを確認する（品質基準: 90%以上）

---

## 実装範囲

### 対象ファイル

新規作成:
- `templates/laravel/.claude/skills/tdd-refactor/SKILL.md` - tdd-refactor Skillの定義

### 対象外

- 自動リファクタリングツール（将来追加検討）
- スラッシュコマンド（後のフェーズで実装）
- 他のSkills

---

## アーキテクチャ設計

### ファイル構成

```
templates/laravel/.claude/skills/tdd-refactor/
└── SKILL.md                      # Skill定義
```

### SKILL.mdの構造

```yaml
---
name: tdd-refactor
description: REFACTORフェーズ用。GREENフェーズで作成した実装をリファクタリングし、コード品質を改善する。テストを維持しながら、DRY原則の適用、定数化、メソッド分割、ネーミング改善等を行う。ユーザーが「refactor」「リファクタリング」と言った時、GREENフェーズ完了後、または /tdd-refactor コマンド実行時に使用。
allowed-tools: Read, Write, Edit, Grep, Glob, Bash
---

# TDD REFACTOR Phase

[Skillの詳細内容]
```

### Skillの振る舞い

1. **発動時**
   - テストを実行して全テストが通っていることを確認
   - PLAN.mdを参照して品質基準を確認
   - GREENフェーズで実装したファイルを確認

2. **リファクタリングフェーズ**
   - 以下の順序でリファクタリング:
     1. 重複コード削除（DRY原則）
     2. マジックナンバー/文字列の定数化
     3. 長いメソッドの分割
     4. 複雑な条件式の簡潔化
     5. ネーミング改善
   - 各変更後にテストを実行
   - テストが失敗したら変更を戻す

3. **品質チェックフェーズ**
   - PHPStan実行（Level 8）
   - Laravel Pint実行（コード整形）
   - テストカバレッジ確認（90%以上）
   - エラーがあれば修正

4. **完了フェーズ**
   - リファクタリング内容のサマリー表示
   - 品質チェック結果の表示
   - 次のフェーズ（REVIEW）を案内

---

## テストケース一覧

このプロジェクトはSkillsの実装なので、テストは手動確認になります。

### 手動テストケース

1. **Skill発動テスト**
   - 条件: Laravelプロジェクトで「refactor」と発言
   - 期待: tdd-refactor Skillが読み込まれる

2. **事前テスト確認テスト**
   - 条件: Skill発動後
   - 期待: テストが実行される
   - 期待: 全テストが通っていることを確認

3. **DRY原則適用テスト**
   - 条件: 重複コードが存在
   - 期待: 共通化される

4. **定数化テスト**
   - 条件: マジックナンバーが存在
   - 期待: 定数に置き換えられる

5. **テスト維持テスト**
   - 条件: リファクタリング中
   - 期待: 各変更後にテストが実行される
   - 期待: テストが通り続ける

6. **PHPStan実行テスト**
   - 条件: リファクタリング完了後
   - 期待: `vendor/bin/phpstan analyse` が実行される
   - 期待: Level 8でエラー0件

7. **Laravel Pint実行テスト**
   - 条件: リファクタリング完了後
   - 期待: `vendor/bin/pint` が実行される
   - 期待: コードが整形される

8. **テストカバレッジ確認テスト**
   - 条件: リファクタリング完了後
   - 期待: `php artisan test --coverage` が実行される
   - 期待: 90%以上のカバレッジ

9. **次フェーズ案内テスト**
   - 条件: REFACTORフェーズ完了
   - 期待: REVIEWフェーズへの移行が案内される

---

## 見積もり

- SKILL.md作成: 60分
- 動作確認（手動テスト）: 30分
- ドキュメント更新: 15分

**合計**: 約1時間45分

---

## 依存関係

### 前提条件
- GREENフェーズが完了していること
- 実装ファイルが存在すること
- すべてのテストが通っていること
- PLAN.mdに品質基準が記載されていること

### 今後の依存
- `tdd-review` Skillが、このフェーズで改善したコードをレビューする

---

## リスク

### リスク1: リファクタリング中にテストが失敗する

**発生条件**: 不適切なリファクタリング
**対策**: 小さい単位でリファクタリングし、各変更後にテスト実行

### リスク2: PHPStanでエラーが多数発生

**発生条件**: GREENフェーズの実装が型安全でない
**対策**: 段階的に修正、必要に応じてPLAN.mdの品質基準を調整

### リスク3: 過剰なリファクタリング

**発生条件**: Claude Codeが完璧なコードを書こうとする
**対策**: 「必要最小限の改善」を強調、テストが通れば十分

---

## 次のステップ

1. [完了] INIT（要件定義）
2. [完了] PLAN作成（このドキュメント）
3. [次] PLAN REVIEW（ユーザー承認）
4. [未] RED（手動テストケース作成）
5. [未] GREEN（SKILL.md実装）
6. [未] REFACTOR（内容の洗練）
7. [未] REVIEW（動作確認）
8. [未] DOC（README更新）
9. [未] COMMIT

---

*作成日時: 2025-10-27 00:30*
*次のフェーズ: PLAN REVIEW*
