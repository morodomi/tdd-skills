# Laravel TDD Framework - 要件定義書

## 📋 プロジェクト概要

### プロジェクト名
**Laravel TDD Orchestrator**

### 目的
PHP/Laravel開発において、Claude SkillsとMCPを活用した厳格なTDD開発環境を、
git cloneで任意のプロジェクトに導入可能な再利用可能パッケージとして提供する。

### 背景
- **現状**: Claude Codeで開発しているが、脇道に逸れることがある
- **課題**: ハルシネーション、焦点のブレ、品質の不一致
- **解決策**: 厳格なゲート制御と自動検証による「レールに乗った開発」

---

## 🎯 目標

### 1. 再利用性
```bash
# 任意のLaravelプロジェクトで使用可能
cd my-laravel-project
git clone https://github.com/yourname/laravel-tdd-orchestrator .tdd
./tdd/install.sh
```

### 2. 厳格性
- 各フェーズで明確なゲート条件
- 条件を満たさない限り次に進めない
- 自動チェックによる品質保証

### 3. フォーカスの維持
- 脇道防止のための自動アラート
- 実装範囲の明確化
- 不要な機能追加の防止

### 4. Laravel特化
- Laravel規約に完全準拠
- PHPStan/Psalm対応
- PHPUnit/Pest統合
- Eloquent/Query Builder最適化

---

## 📊 現在のワークフロー vs 提案するワークフロー

### 現在のワークフロー

```
INIT → PLAN → ドキュメント作成
          ↓
     PLANレビュー
          ↓
     TEST/実装/リファクタ（同時進行）
          ↓
     REVIEW
          ↓
     docs更新（PLANからアップデート）
          ↓
     コミット完了
```

**課題**:
- TEST/実装/リファクタが曖昧
- 脇道に逸れやすい
- ゲート条件が不明確
- 品質チェックが手動

---

### 提案するワークフロー

```
INIT (初期化)
  ↓ [厳格なゲート]
PLAN (計画)
  ↓ [自動検証]
PLAN REVIEW (計画レビュー) ← NEW!
  ↓ [承認ゲート]
TEST (テスト作成) ← 分離
  ↓ [実行可能性チェック]
GREEN (実装) ← 分離
  ↓ [全テスト合格確認]
REFACTOR (リファクタリング) ← 分離
  ↓ [品質メトリクス確認]
REVIEW (品質検証)
  ↓ [総合チェック]
DOC (ドキュメント更新)
  ↓ [完全性確認]
COMMIT (コミット準備)
  ↓
DONE
```

**改善点**:
- ✅ 各フェーズが明確に分離
- ✅ 自動ゲート条件
- ✅ PLAN REVIEWで方向性を確定
- ✅ TEST → GREEN → REFACTORを厳格に分離
- ✅ 各フェーズで自動検証

---

## 🔧 機能要件

### 1. コアコンポーネント

#### 1.1 TDD Orchestrator CLI
```bash
# 基本コマンド
./tdd init "ユーザー認証機能の追加"
./tdd plan
./tdd test
./tdd green
./tdd refactor
./tdd review
./tdd doc
./tdd commit

# ステータス確認
./tdd status

# ゲートチェック
./tdd gate check
./tdd gate force  # 緊急時のみ
```

#### 1.2 ゲート管理システム
```php
// 各フェーズのゲート条件を自動チェック
Gate::check('test');  // テストフェーズのゲート条件確認
Gate::force('test');  // 強制通過（ログに記録）
```

#### 1.3 進捗トラッキング
```
現在のフェーズ: TEST
進捗: [INIT:✅] [PLAN:✅] [PLAN_REVIEW:✅] [TEST:⏳] [GREEN:⏸️]

未完了のゲート条件:
❌ すべてのテストケースが実装済み (2/5 完了)
✅ テストが実行可能
✅ カバレッジ目標が設定済み
```

---

### 2. Claude Skills統合

#### 2.1 Laravel TDD Skill
- Laravel規約に準拠したコード生成
- Eloquent/Query Builderの最適化
- PHPDocの自動生成
- テストケース生成

#### 2.2 Plan Review Skill
- 実装範囲の妥当性チェック
- スコープクリープの検出
- 依存関係の検証
- 見積もりの精度確認

#### 2.3 Laravel Quality Skill
- PHPStan/Psalm統合
- PHPUnit/Pest統合
- Laravel Pint統合
- Larastan統合

---

### 3. MCP Server統合

#### 3.1 PHPStan MCP
```json
{
  "name": "phpstan",
  "command": "phpstan",
  "args": ["analyse", "--level=9", "--memory-limit=1G"]
}
```

#### 3.2 PHPUnit MCP
```json
{
  "name": "phpunit",
  "command": "vendor/bin/phpunit",
  "args": ["--coverage-html=coverage", "--coverage-text"]
}
```

#### 3.3 Laravel Pint MCP
```json
{
  "name": "pint",
  "command": "vendor/bin/pint",
  "args": ["--test"]
}
```

#### 3.4 Larastan MCP
```json
{
  "name": "larastan",
  "command": "vendor/bin/phpstan",
  "args": ["analyse", "--configuration=larastan.neon"]
}
```

---

### 4. 自動検証機能

#### 4.1 ハルシネーション検出（PHP版）
```php
// Laravel特有のハルシネーションを検出
- 存在しないEloquentメソッドの使用
- 存在しないFacadeの使用
- 存在しないBladeディレクティブ
- 存在しないArtisanコマンド
```

#### 4.2 スコープ検証
```php
// PLAN文書と実装の乖離を検出
- PLAN外のファイル作成
- PLAN外の機能実装
- 不要なリファクタリング
```

#### 4.3 品質メトリクス
```php
// 自動計測
- PHPStan Level (目標: 9)
- テストカバレッジ (目標: 80%以上)
- Cyclomatic Complexity (目標: ≤10)
- CRAP Score (目標: ≤30)
```

---

### 5. ドキュメント管理

#### 5.1 自動生成ドキュメント
```
docs/
├── INIT.md           # 初期要件
├── PLAN.md           # 実装計画
├── PLAN_REVIEW.md    # 計画レビュー結果
├── ARCHITECTURE.md   # アーキテクチャ設計
├── TEST_SPEC.md      # テスト仕様
├── IMPLEMENTATION.md # 実装記録
└── CHANGELOG.md      # 変更履歴
```

#### 5.2 ドキュメント検証
```bash
# ドキュメントの完全性チェック
./tdd doc validate

# ドキュメントの整合性チェック（PLANと実装の差異）
./tdd doc diff
```

---

## 🚫 非機能要件

### 1. パフォーマンス
- ゲートチェック: < 5秒
- 静的解析: < 30秒
- テスト実行: プロジェクト依存（目安: < 2分）

### 2. 互換性
- PHP: 8.1+
- Laravel: 10.x, 11.x
- Composer: 2.x
- Git: 2.x

### 3. 移植性
- OS: macOS, Linux, WSL2
- CI/CD: GitHub Actions, GitLab CI対応
- Docker対応

### 4. 保守性
- 設定ファイルで挙動カスタマイズ可能
- プラグイン機構でMCP追加可能
- ログ出力で問題追跡可能

---

## 📦 提供形態

### インストール方法

```bash
# 1. リポジトリをクローン
cd your-laravel-project
git clone https://github.com/yourname/laravel-tdd-orchestrator .tdd

# 2. インストールスクリプト実行
./tdd/install.sh

# 3. 設定ファイル生成
./tdd init-config

# 4. Claude Skills / MCP設定
./tdd setup-claude
```

### ディレクトリ構造（インストール後）

```
your-laravel-project/
├── .tdd/                          # TDD Orchestrator
│   ├── bin/
│   │   └── tdd                    # メインCLI
│   ├── skills/
│   │   ├── laravel-tdd/           # Laravel TDD Skill
│   │   ├── plan-review/           # Plan Review Skill
│   │   └── laravel-quality/       # Laravel Quality Skill
│   ├── mcp/
│   │   ├── phpstan-mcp/           # PHPStan MCP
│   │   ├── phpunit-mcp/           # PHPUnit MCP
│   │   ├── pint-mcp/              # Pint MCP
│   │   └── larastan-mcp/          # Larastan MCP
│   ├── scripts/
│   │   ├── gate-checker.php       # ゲートチェッカー
│   │   ├── hallucination-detector.php
│   │   └── scope-validator.php
│   ├── config/
│   │   ├── tdd.json               # TDD設定
│   │   ├── gates.json             # ゲート条件
│   │   └── metrics.json           # 品質メトリクス基準
│   └── templates/
│       ├── INIT.md.template
│       ├── PLAN.md.template
│       └── ...
│
├── docs/                          # 自動生成ドキュメント
│   ├── tdd/
│   │   ├── INIT.md
│   │   ├── PLAN.md
│   │   └── ...
│
├── .tdd-state.json                # 現在の状態
└── TDD-RULES.md                   # プロジェクト固有ルール
```

---

## 🎯 ユースケース

### ケース1: 新機能の追加

```bash
# 1. 初期化
./tdd init "ユーザープロフィール編集機能"

# 2. 計画作成（Claude Codeで実施）
# → docs/tdd/PLAN.md が生成される

# 3. 計画レビュー
./tdd plan review
# → スコープ妥当性をチェック
# → 見積もりを検証
# → 依存関係を確認

# 4. 承認
./tdd plan approve

# 5. テスト作成（Claude Codeで実施）
# → tests/ 配下にテストコード作成

# 6. テストフェーズのゲートチェック
./tdd gate check test
# ✅ すべてのテストケースが実装済み
# ✅ テストが実行可能
# ✅ すべてのテストが失敗（Red状態）
# ✅ カバレッジ目標が設定済み

# 7. 実装（Claude Codeで実施）
# → app/ 配下に実装コード作成

# 8. GREENフェーズのゲートチェック
./tdd gate check green
# ✅ すべてのテストがパス
# ✅ カバレッジ80%以上
# ✅ PHPStan Level 9合格

# 9. リファクタリング（Claude Codeで実施）
./tdd refactor

# 10. REFACTORフェーズのゲートチェック
./tdd gate check refactor
# ✅ すべてのテストがパス（維持）
# ✅ Lintエラーゼロ
# ✅ 複雑度メトリクスが基準以下

# 11. レビュー
./tdd review
# → 総合的な品質チェック

# 12. ドキュメント更新
./tdd doc update

# 13. コミット準備
./tdd commit
# → 自動的にコミットメッセージ生成
# → 変更履歴を記録
```

---

### ケース2: バグ修正

```bash
# 1. 初期化（バグ修正モード）
./tdd init --bug "ログイン時にセッションが保存されない #123"

# 2. 計画は簡略化（バグ修正は範囲が明確）
./tdd plan quick

# 3. 再現テスト作成
# → 既存のテストに追加

# 4. 修正実装

# 5. 検証
./tdd review --bug

# 6. コミット
./tdd commit --bug
```

---

## 🔐 制約事項

### 必須の制約

1. **フェーズの順序厳守**
   - 前のフェーズのゲート条件を満たさない限り次に進めない
   - 例外: `./tdd gate force` での強制突破（ログに記録）

2. **スコープ遵守**
   - PLAN.mdで定義した範囲外の実装を検出
   - 検出時は警告 + 人間の承認が必要

3. **品質基準の遵守**
   - PHPStan Level 9必須
   - テストカバレッジ80%以上必須
   - Complexity ≤ 10 必須

4. **ドキュメント同期**
   - 実装とドキュメントの乖離を検出
   - 乖離検出時はREVIEWフェーズで停止

### オプションの制約（設定可能）

1. **コミットメッセージ形式**
   - Conventional Commits準拠
   - カスタマイズ可能

2. **ブランチ戦略**
   - Git Flow
   - GitHub Flow
   - GitLab Flow

3. **レビュー要件**
   - 自動レビューのみ
   - 人間レビュー必須
   - ハイブリッド

---

## 📈 成功指標

### 定量的指標

| 指標 | 現状（想定） | 目標 |
|------|------------|------|
| ハルシネーション発生率 | 15% | < 5% |
| スコープ逸脱率 | 30% | < 10% |
| テストカバレッジ | 60% | ≥ 80% |
| PHPStan合格率 | 70% | 100% |
| リワーク率 | 25% | < 10% |
| 1機能あたりの開発時間 | 6時間 | 4時間 |

### 定性的指標

- ✅ Claude Codeが脇道に逸れない
- ✅ 品質が一定に保たれる
- ✅ ドキュメントと実装が常に同期
- ✅ レビュー時間が短縮
- ✅ バグ発生率が低下

---

## 🗓️ 開発フェーズ

### Phase 1: コアフレームワーク（2週間）
- [ ] CLI基盤（PHPベース）
- [ ] ゲート管理システム
- [ ] 状態管理
- [ ] 基本的なコマンド実装

### Phase 2: Laravel統合（2週間）
- [ ] Laravel Skillの実装
- [ ] PHPStan/Larastan統合
- [ ] PHPUnit/Pest統合
- [ ] Laravel Pint統合

### Phase 3: MCP統合（2週間）
- [ ] PHPStan MCP
- [ ] PHPUnit MCP
- [ ] Pint MCP
- [ ] Larastan MCP

### Phase 4: 高度な機能（2週間）
- [ ] ハルシネーション検出（PHP版）
- [ ] スコープ検証
- [ ] 自動ドキュメント生成
- [ ] 差分検出

### Phase 5: 検証と改善（1週間）
- [ ] 実プロジェクトでの試用
- [ ] フィードバック収集
- [ ] 改善実施

---

## 📚 参考資料

### Laravel関連
- [Laravel Documentation](https://laravel.com/docs)
- [Laravel Best Practices](https://github.com/alexeymezenin/laravel-best-practices)
- [Spatie Guidelines](https://spatie.be/guidelines/laravel-php)

### 品質ツール
- [PHPStan Documentation](https://phpstan.org/user-guide/getting-started)
- [Larastan](https://github.com/larastan/larastan)
- [Psalm](https://psalm.dev/)
- [Laravel Pint](https://laravel.com/docs/pint)

### テスティング
- [PHPUnit](https://phpunit.de/)
- [Pest](https://pestphp.com/)
- [Laravel Testing](https://laravel.com/docs/testing)

---

## 🤝 貢献

このプロジェクトはオープンソースとして公開予定。
コミュニティからのフィードバックと改善提案を歓迎します。

---

## 📝 次のステップ

1. ✅ 要件定義書（このドキュメント）
2. ⏭️ システム設計書
3. ⏭️ 実装計画書
4. ⏭️ Claude Codeでの実装

---

*最終更新: 2025-10-22*
*バージョン: 1.0*
